Wed Dec 15 03:13:51 PM EET 2021
+ hostname
linyxa
+ ansible-playbook infra.yaml --diff

PLAY [Init] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [init : Update APT cache] *************************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-1]

TASK [init : Install iptables-persistent] **************************************
The following additional packages will be installed:
  netfilter-persistent
The following NEW packages will be installed:
  iptables-persistent netfilter-persistent
0 upgraded, 2 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  netfilter-persistent
The following NEW packages will be installed:
  iptables-persistent netfilter-persistent
0 upgraded, 2 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-1]
The following additional packages will be installed:
  netfilter-persistent
The following NEW packages will be installed:
  iptables-persistent netfilter-persistent
0 upgraded, 2 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-3]

TASK [init : Copy iptables.mangle] *********************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -0,0 +1,8 @@
+*mangle
+:PREROUTING ACCEPT [0:0]
+:INPUT ACCEPT [0:0]
+:FORWARD ACCEPT [0:0]
+:OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
+COMMIT

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -0,0 +1,8 @@
+*mangle
+:PREROUTING ACCEPT [0:0]
+:INPUT ACCEPT [0:0]
+:FORWARD ACCEPT [0:0]
+:OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
+COMMIT

changed: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -0,0 +1,8 @@
+*mangle
+:PREROUTING ACCEPT [0:0]
+:INPUT ACCEPT [0:0]
+:FORWARD ACCEPT [0:0]
+:OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
+COMMIT

changed: [LeonidVagulin-1]

TASK [init : Copy /etc/iptables/rules.v4] **************************************
--- before: /etc/iptables/rules.v4
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -1,7 +1,8 @@
-# Generated by iptables-save v1.8.4 on Wed Dec 15 13:14:13 2021
-*filter
+*mangle
+:PREROUTING ACCEPT [0:0]
 :INPUT ACCEPT [0:0]
 :FORWARD ACCEPT [0:0]
 :OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
 COMMIT
-# Completed on Wed Dec 15 13:14:13 2021

changed: [LeonidVagulin-2]
--- before: /etc/iptables/rules.v4
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -1,7 +1,8 @@
-# Generated by iptables-save v1.8.4 on Wed Dec 15 13:14:13 2021
-*filter
+*mangle
+:PREROUTING ACCEPT [0:0]
 :INPUT ACCEPT [0:0]
 :FORWARD ACCEPT [0:0]
 :OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
 COMMIT
-# Completed on Wed Dec 15 13:14:13 2021

changed: [LeonidVagulin-3]
--- before: /etc/iptables/rules.v4
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/init/templates/iptables.mangle
@@ -1,7 +1,8 @@
-# Generated by iptables-save v1.8.4 on Wed Dec 15 13:14:13 2021
-*filter
+*mangle
+:PREROUTING ACCEPT [0:0]
 :INPUT ACCEPT [0:0]
 :FORWARD ACCEPT [0:0]
 :OUTPUT ACCEPT [0:0]
+:POSTROUTING ACCEPT [0:0]
+-A POSTROUTING -o ens3 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1400 --clamp-mss-to-pmtu
 COMMIT
-# Completed on Wed Dec 15 13:14:13 2021

changed: [LeonidVagulin-1]

TASK [init : Fix for ssl] ******************************************************
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-1]

TASK [node_exporter : Install node exporters] **********************************
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-3]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 140 not upgraded.
changed: [LeonidVagulin-1]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [rsyslog : copy pinger.service] *******************************************
--- before: /etc/rsyslog.conf
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/rsyslog/templates/rsyslog.conf
@@ -57,3 +57,8 @@
 # Include all config files in /etc/rsyslog.d/
 #
 $IncludeConfig /etc/rsyslog.d/*.conf
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+*.* @LeonidVagulin-1:6514;RSYSLOG_SyslogProtocol23Format

changed: [LeonidVagulin-2]
--- before: /etc/rsyslog.conf
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/rsyslog/templates/rsyslog.conf
@@ -57,3 +57,8 @@
 # Include all config files in /etc/rsyslog.d/
 #
 $IncludeConfig /etc/rsyslog.d/*.conf
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+*.* @LeonidVagulin-1:6514;RSYSLOG_SyslogProtocol23Format

changed: [LeonidVagulin-1]
--- before: /etc/rsyslog.conf
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/rsyslog/templates/rsyslog.conf
@@ -57,3 +57,8 @@
 # Include all config files in /etc/rsyslog.d/
 #
 $IncludeConfig /etc/rsyslog.d/*.conf
+$ActionQueueType LinkedList # use asynchronous processing
+$ActionQueueFileName srvrfwd # set file name, also enables disk mode
+$ActionResumeRetryCount -1 # infinite retries on insert failure
+$ActionQueueSaveOnShutdown on # save in-memory data if rsyslog shuts down
+*.* @LeonidVagulin-1:6514;RSYSLOG_SyslogProtocol23Format

changed: [LeonidVagulin-3]

RUNNING HANDLER [rsyslog : restart rsyslog] ************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-1]
changed: [LeonidVagulin-3]

PLAY [DNS server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]

TASK [bind : install bind9] ****************************************************
The following additional packages will be installed:
  bind9-dnsutils bind9-libs bind9-utils dns-root-data python3-ply
Suggested packages:
  bind-doc resolvconf python-ply-doc
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-ply
The following packages will be upgraded:
  bind9-dnsutils bind9-libs
2 upgraded, 5 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  bind9-dnsutils bind9-libs bind9-utils dns-root-data python3-ply
Suggested packages:
  bind-doc resolvconf python-ply-doc
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-ply
The following packages will be upgraded:
  bind9-dnsutils bind9-libs
2 upgraded, 5 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-1]
The following additional packages will be installed:
  bind9-dnsutils bind9-libs bind9-utils dns-root-data python3-ply
Suggested packages:
  bind-doc resolvconf python-ply-doc
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-ply
The following packages will be upgraded:
  bind9-dnsutils bind9-libs
2 upgraded, 5 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [bind : bind9 service start and conf] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : Template named.conf.options] **************************************
--- before: /etc/bind/named.conf.options
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmppbqpbk6z/named.conf.options
@@ -1,24 +1,24 @@
+acl lan { 192.168.42.0/24; 127.0.0.0/8; 172.17.0.0/16;};
 options {
 	directory "/var/cache/bind";
+	forwarders {
+		8.8.8.8;
+		1.1.1.1;
+	 };
+	 allow-query { lan;
+	  };
+	 dnssec-validation no;
+};
+statistics-channels {
+  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
+};
 
-	// If there is a firewall between you and nameservers you want
-	// to talk to, you may need to fix the firewall to allow multiple
-	// ports to talk.  See http://www.kb.cert.org/vuls/id/800113
+key "nsupdate.key" {
+	algorithm hmac-sha256;
+	secret "HpxjGC3oyepvQZh1fxoOKUP289t5Oj5iZ9qE2kMPji4=";
+};
 
-	// If your ISP provided one or more IP addresses for stable 
-	// nameservers, you probably want to use them as forwarders.  
-	// Uncomment the following block, and insert the addresses replacing 
-	// the all-0's placeholder.
-
-	// forwarders {
-	// 	0.0.0.0;
-	// };
-
-	//========================================================================
-	// If BIND logs error messages about the root key being expired,
-	// you will need to update your keys.  See https://www.isc.org/bind-keys
-	//========================================================================
-	dnssec-validation auto;
-
-	listen-on-v6 { any; };
+key "transfer.key" {
+	algorithm hmac-sha256;
+	secret "X7CeDRf6Csp2mL0v0icIgg5uTnKzskGCy27YIYmVRXw=";
 };

changed: [LeonidVagulin-2]
--- before: /etc/bind/named.conf.options
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpq9zm8x3j/named.conf.options
@@ -1,24 +1,24 @@
+acl lan { 192.168.42.0/24; 127.0.0.0/8; 172.17.0.0/16;};
 options {
 	directory "/var/cache/bind";
+	forwarders {
+		8.8.8.8;
+		1.1.1.1;
+	 };
+	 allow-query { lan;
+	  };
+	 dnssec-validation no;
+};
+statistics-channels {
+  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
+};
 
-	// If there is a firewall between you and nameservers you want
-	// to talk to, you may need to fix the firewall to allow multiple
-	// ports to talk.  See http://www.kb.cert.org/vuls/id/800113
+key "nsupdate.key" {
+	algorithm hmac-sha256;
+	secret "HpxjGC3oyepvQZh1fxoOKUP289t5Oj5iZ9qE2kMPji4=";
+};
 
-	// If your ISP provided one or more IP addresses for stable 
-	// nameservers, you probably want to use them as forwarders.  
-	// Uncomment the following block, and insert the addresses replacing 
-	// the all-0's placeholder.
-
-	// forwarders {
-	// 	0.0.0.0;
-	// };
-
-	//========================================================================
-	// If BIND logs error messages about the root key being expired,
-	// you will need to update your keys.  See https://www.isc.org/bind-keys
-	//========================================================================
-	dnssec-validation auto;
-
-	listen-on-v6 { any; };
+key "transfer.key" {
+	algorithm hmac-sha256;
+	secret "X7CeDRf6Csp2mL0v0icIgg5uTnKzskGCy27YIYmVRXw=";
 };

changed: [LeonidVagulin-1]
--- before: /etc/bind/named.conf.options
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpp6eg7ydg/named.conf.options
@@ -1,24 +1,24 @@
+acl lan { 192.168.42.0/24; 127.0.0.0/8; 172.17.0.0/16;};
 options {
 	directory "/var/cache/bind";
+	forwarders {
+		8.8.8.8;
+		1.1.1.1;
+	 };
+	 allow-query { lan;
+	  };
+	 dnssec-validation no;
+};
+statistics-channels {
+  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
+};
 
-	// If there is a firewall between you and nameservers you want
-	// to talk to, you may need to fix the firewall to allow multiple
-	// ports to talk.  See http://www.kb.cert.org/vuls/id/800113
+key "nsupdate.key" {
+	algorithm hmac-sha256;
+	secret "HpxjGC3oyepvQZh1fxoOKUP289t5Oj5iZ9qE2kMPji4=";
+};
 
-	// If your ISP provided one or more IP addresses for stable 
-	// nameservers, you probably want to use them as forwarders.  
-	// Uncomment the following block, and insert the addresses replacing 
-	// the all-0's placeholder.
-
-	// forwarders {
-	// 	0.0.0.0;
-	// };
-
-	//========================================================================
-	// If BIND logs error messages about the root key being expired,
-	// you will need to update your keys.  See https://www.isc.org/bind-keys
-	//========================================================================
-	dnssec-validation auto;
-
-	listen-on-v6 { any; };
+key "transfer.key" {
+	algorithm hmac-sha256;
+	secret "X7CeDRf6Csp2mL0v0icIgg5uTnKzskGCy27YIYmVRXw=";
 };

changed: [LeonidVagulin-3]

TASK [bind : Copy db.deez] *****************************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpxyo1k6pa/db.deez
@@ -0,0 +1,15 @@
+$TTL	604800
+deez.lv.	IN	SOA	LeonidVagulin-1.deez.lv. leonid.deez.lv. (
+			      2		; Serial
+			 604800		; Refresh
+			  86400		; Retry
+			2419200		; Expire
+			 604800 )	; Negative Cache TTL
+;
+deez.lv.	IN	NS	LeonidVagulin-1
+deez.lv.	IN	NS	LeonidVagulin-2
+deez.lv.	IN	NS	LeonidVagulin-3
+LeonidVagulin-3 IN	A	192.168.42.21
+LeonidVagulin-2 IN	A	192.168.42.29
+LeonidVagulin-1 IN	A	192.168.42.45
+

changed: [LeonidVagulin-1]

TASK [bind : Copy db.domain.reverse] *******************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp63tmisxw/db.domain.reverse
@@ -0,0 +1,15 @@
+$TTL	604800
+42.168.192.in-addr.arpa.	IN	SOA	LeonidVagulin-1.deez.lv. leonid.deez.lv. (
+			      2		; Serial
+			 604800		; Refresh
+			  86400		; Retry
+			2419200		; Expire
+			 604800 )	; Negative Cache TTL
+;
+42.168.192.in-addr.arpa.	IN	NS	LeonidVagulin-1.deez.lv.
+42.168.192.in-addr.arpa.	IN	NS	LeonidVagulin-2.deez.lv.
+42.168.192.in-addr.arpa.	IN	NS	LeonidVagulin-3.deez.lv.
+21	IN	PTR	LeonidVagulin-3.deez.lv.
+29	IN	PTR	LeonidVagulin-2.deez.lv.
+45	IN	PTR	LeonidVagulin-1.deez.lv.
+

changed: [LeonidVagulin-1]

TASK [bind : Copy local.conf] **************************************************
--- before: /etc/bind/named.conf.local
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpkrgnib9o/named.conf.local
@@ -1,8 +1,14 @@
-//
-// Do any local configuration here
-//
+zone "deez.lv" {
+	type master;
+	allow-update {key nsupdate.key;};
+	allow-transfer {127.0.0.1; key transfer.key;};
+	file "db.deez";
+};
 
-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
 
+zone "42.168.192.in-addr.arpa" {
+	type master;
+	allow-update {key nsupdate.key;};
+	allow-transfer {127.0.0.1; key transfer.key;};
+	file "db.reverse";
+};

changed: [LeonidVagulin-1]
--- before: /etc/bind/named.conf.local
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp0wheggka/named.conf.local
@@ -1,8 +1,15 @@
-//
-// Do any local configuration here
-//
+zone "deez.lv" {
+        type slave;
+        masters { 192.168.42.45; };
+	file "db.deez";
+};
 
-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
+server 192.168.42.45 {
+      keys { transfer.key;};
+};
 
+zone "42.168.192.in-addr.arpa" {
+        type slave;
+        masters { 192.168.42.45; };
+	file "db.reverse";
+};

changed: [LeonidVagulin-2]
--- before: /etc/bind/named.conf.local
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpbjoh653a/named.conf.local
@@ -1,8 +1,15 @@
-//
-// Do any local configuration here
-//
+zone "deez.lv" {
+        type slave;
+        masters { 192.168.42.45; };
+	file "db.deez";
+};
 
-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
+server 192.168.42.45 {
+      keys { transfer.key;};
+};
 
+zone "42.168.192.in-addr.arpa" {
+        type slave;
+        masters { 192.168.42.45; };
+	file "db.reverse";
+};

changed: [LeonidVagulin-3]

TASK [bind : shutdown systemd-resolved] ****************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-1]

TASK [bind : Template resolv.conf] *********************************************
--- before: /etc/resolv.conf
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpv1p2feee/resolv.conf
@@ -1,19 +1,3 @@
-# This file is managed by man:systemd-resolved(8). Do not edit.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs must not access this file directly, but only through the
-# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
-# replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+nameserver 192.168.42.29
+nameserver 192.168.42.21
+search deez.lv

changed: [LeonidVagulin-2]
--- before: /etc/resolv.conf
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp3qsykxu5/resolv.conf
@@ -1,19 +1,3 @@
-# This file is managed by man:systemd-resolved(8). Do not edit.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs must not access this file directly, but only through the
-# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
-# replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+nameserver 192.168.42.29
+nameserver 192.168.42.21
+search deez.lv

changed: [LeonidVagulin-1]
--- before: /etc/resolv.conf
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpmv6yj3of/resolv.conf
@@ -1,19 +1,3 @@
-# This file is managed by man:systemd-resolved(8). Do not edit.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs must not access this file directly, but only through the
-# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
-# replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+nameserver 192.168.42.29
+nameserver 192.168.42.21
+search deez.lv

changed: [LeonidVagulin-3]

TASK [bind_exporter : Install prometheus-bind-exporter] ************************
The following NEW packages will be installed:
  prometheus-bind-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following NEW packages will be installed:
  prometheus-bind-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-1]
The following NEW packages will be installed:
  prometheus-bind-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [bind_exporter : conf prometheus-bind-exporter] ***************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

RUNNING HANDLER [bind : Restart bind] ******************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-1]
changed: [LeonidVagulin-3]

PLAY [InfluxDB] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-1]

TASK [influxdb : apt_key] ******************************************************
changed: [LeonidVagulin-1]

TASK [influxdb : apt_repository] ***********************************************
--- before: /dev/null
+++ after: /etc/apt/sources.list.d/repos_influxdata_com_ubuntu.list
@@ -0,0 +1 @@
+deb https://repos.influxdata.com/ubuntu focal stable

changed: [LeonidVagulin-1]

TASK [influxdb : Install  influx and telegraf] *********************************
The following NEW packages will be installed:
  influxdb telegraf
0 upgraded, 2 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-1]

TASK [influxdb : influx service start and conf] ********************************
changed: [LeonidVagulin-1]

TASK [influxdb : config telegraf to recieve rsyslog and send to influx] ********
diff skipped: destination file size is greater than 104448
changed: [LeonidVagulin-1]

TASK [influxdb : config influxdb logging msg] **********************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/influxdb/templates/influxdb.conf
@@ -0,0 +1,22 @@
+[meta]
+  dir = "/var/lib/influxdb/meta"
+[data]
+  dir = "/var/lib/influxdb/data"
+  wal-dir = "/var/lib/influxdb/wal"
+  series-id-set-cache-size = 100
+  query-log-enabled = false
+[coordinator]
+[retention]
+[shard-precreation]
+[monitor]
+[http]
+  log-enabled = false
+  write-tracing = false
+[logging]
+[subscriber]
+[[graphite]]
+[[collectd]]
+[[opentsdb]]
+[[udp]]
+[continuous_queries]
+[tls]

changed: [LeonidVagulin-1]

TASK [influxdb_exporter : install influxdb stats exporter] *********************
changed: [LeonidVagulin-1]

TASK [influxdb_exporter : Changing perm of influx db stats exporter] ***********
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "mode": "0644",
+    "mode": "0755",
     "path": "/usr/local/bin/influx_stats_exporter_linux_amd64"
 }

changed: [LeonidVagulin-1]

TASK [influxdb_exporter : copy service for influx db stats exporter] ***********
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/influxdb_exporter/templates/prometheus-influxdb-stats-exporter.service
@@ -0,0 +1,11 @@
+[Unit]
+Description=influxdb stats exporter
+Documentation=https://github.com/carlpett/influxdb_stats_exporter
+After=network-online.target
+
+[Service]
+User=prometheus
+ExecStart=/usr/local/bin/influx_stats_exporter_linux_amd64
+
+[Install]
+WantedBy=multi-user.target

changed: [LeonidVagulin-1]

TASK [influxdb_exporter : daemon reload] ***************************************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : prometheus-influxdb-stats-exporterservice start and conf] ***
changed: [LeonidVagulin-1]

TASK [influxdb_backup : Create a directory for influxdb backup] ****************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/influxdb",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-1]

TASK [influxdb_backup : Install   python3-pip] *********************************
The following additional packages will be installed:
  binutils binutils-common binutils-x86-64-linux-gnu build-essential cpp cpp-9
  dpkg-dev fakeroot g++ g++-9 gcc gcc-10-base gcc-9 gcc-9-base
  libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
  libasan5 libatomic1 libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev
  libctf-nobfd0 libctf0 libdpkg-perl libexpat1-dev libfakeroot
  libfile-fcntllock-perl libgcc-9-dev libgcc-s1 libgomp1 libisl22 libitm1
  liblsan0 libmpc3 libpython3-dev libpython3.8 libpython3.8-dev
  libpython3.8-minimal libpython3.8-stdlib libquadmath0 libstdc++-9-dev
  libstdc++6 libtsan0 libubsan1 linux-libc-dev make manpages-dev
  python-pip-whl python3-dev python3-wheel python3.8 python3.8-dev
  python3.8-minimal zlib1g-dev
Suggested packages:
  binutils-doc cpp-doc gcc-9-locales debian-keyring g++-multilib
  g++-9-multilib gcc-9-doc gcc-multilib autoconf automake libtool flex bison
  gdb gcc-doc gcc-9-multilib glibc-doc bzr libstdc++-9-doc make-doc
  python3.8-venv python3.8-doc binfmt-support
The following NEW packages will be installed:
  binutils binutils-common binutils-x86-64-linux-gnu build-essential cpp cpp-9
  dpkg-dev fakeroot g++ g++-9 gcc gcc-9 gcc-9-base libalgorithm-diff-perl
  libalgorithm-diff-xs-perl libalgorithm-merge-perl libasan5 libatomic1
  libbinutils libc-dev-bin libc6-dev libcc1-0 libcrypt-dev libctf-nobfd0
  libctf0 libdpkg-perl libexpat1-dev libfakeroot libfile-fcntllock-perl
  libgcc-9-dev libgomp1 libisl22 libitm1 liblsan0 libmpc3 libpython3-dev
  libpython3.8-dev libquadmath0 libstdc++-9-dev libtsan0 libubsan1
  linux-libc-dev make manpages-dev python-pip-whl python3-dev python3-pip
  python3-wheel python3.8-dev zlib1g-dev
The following packages will be upgraded:
  gcc-10-base libgcc-s1 libpython3.8 libpython3.8-minimal libpython3.8-stdlib
  libstdc++6 python3.8 python3.8-minimal
8 upgraded, 50 newly installed, 0 to remove and 130 not upgraded.
changed: [LeonidVagulin-1]

TASK [influxdb_backup : Install influxdb for pip] ******************************
changed: [LeonidVagulin-1]

TASK [influxdb_backup : create user backup] ************************************
changed: [LeonidVagulin-1]

TASK [influxdb_backup : crontab update influxdb_backup] ************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/influxdb_backup/files/influxdb-backup
@@ -0,0 +1,3 @@
+19 17 * * 1 rm -rf /home/backup/influxdb/*; influxd backup -portable -database telegraf /home/backup/influxdb
+25 17 * * 1 backup  duplicity --no-encryption full /home/backup/influxdb/ rsync://LeonidVagulin@backup-server.deez.lv//home/LeonidVagulin/
+

changed: [LeonidVagulin-1]

TASK [nginx : nginx] ***********************************************************
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx nginx-common nginx-core
0 upgraded, 17 newly installed, 0 to remove and 130 not upgraded.
changed: [LeonidVagulin-1]

TASK [nginx : copy html] *******************************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/nginx/files/index.html
@@ -0,0 +1,8 @@
+<html>
+    <head>
+        <title>LeonidVagulin-1 - Nginx</title>
+    </head>
+    <body>
+        <h1>Nginx running on LeonidVagulin-1</h1>
+    </body>
+</html>

changed: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpmzgkxnqs/default
@@ -1,91 +1,42 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
-
-# Default server configuration
-#
 server {
 	listen 80 default_server;
-	listen [::]:80 default_server;
+	server_name _;
+        
+        large_client_header_buffers 4 16k;
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
+        location / {
+        proxy_pass http://localhost:8001/;
+        }
+	location /node-metrics {
+	 proxy_pass http://localhost:9100/metrics;
+	}
+	location /node_exporter {
+	 proxy_pass http://localhost:9100/metrics;
+}
 
-	root /var/www/html;
+      location /nginx-metrics {
+	 proxy_pass http://localhost:9113/metrics;
+}
+      location /influxdb-metrics {
+	 proxy_pass http://localhost:9424/metrics;
+}
+      location /haproxy-metrics {
+	 proxy_pass http://localhost:9101/metrics;
+}
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
+      location /keepalived-metrics {
+	 proxy_pass http://localhost:9165/metrics;
+}
 
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
+	location /prometheus {
+	 proxy_pass http://localhost:9090;
+	}
+	
+		
+	location /grafana {
+	 proxy_pass http://localhost:3001;
 	}
 
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
+		
+	}
 
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
-}
-
-
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}

changed: [LeonidVagulin-1]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpg3nouady/exporter
@@ -0,0 +1,6 @@
+server {
+	listen 8080 default_server;
+	location = /stub_status{
+		stub_status;
+	}
+}

changed: [LeonidVagulin-1]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [LeonidVagulin-1]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
changed: [LeonidVagulin-1]

TASK [prometheus : Install prometheus] *****************************************
The following additional packages will be installed:
  fonts-glyphicons-halflings javascript-common libc-ares2 libjs-bootstrap
  libjs-bootstrap4 libjs-d3 libjs-eonasdan-bootstrap-datetimepicker
  libjs-jquery libjs-jquery-hotkeys libjs-moment libjs-moment-timezone
  libjs-mustache libjs-popper.js libjs-rickshaw libnode64 node-jquery nodejs
  nodejs-doc
Suggested packages:
  npm
The following NEW packages will be installed:
  fonts-glyphicons-halflings javascript-common libc-ares2 libjs-bootstrap
  libjs-bootstrap4 libjs-d3 libjs-eonasdan-bootstrap-datetimepicker
  libjs-jquery libjs-jquery-hotkeys libjs-moment libjs-moment-timezone
  libjs-mustache libjs-popper.js libjs-rickshaw libnode64 node-jquery nodejs
  nodejs-doc prometheus
0 upgraded, 19 newly installed, 0 to remove and 130 not upgraded.
changed: [LeonidVagulin-1]

TASK [prometheus : prometheus service start and conf] **************************
ok: [LeonidVagulin-1]

TASK [prometheus : Conf prometheus] ********************************************
--- before: /etc/prometheus/prometheus.yml
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpjcvn9om9/prometheus.yml
@@ -1,44 +1,56 @@
-# Sample config for Prometheus.
-
 global:
   scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
   evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
-  # scrape_timeout is set to the global default (10s).
 
-  # Attach these labels to any time series or alerts when communicating with
-  # external systems (federation, remote storage, Alertmanager).
-  external_labels:
-      monitor: 'example'
-
-# Alertmanager configuration
-alerting:
-  alertmanagers:
-  - static_configs:
-    - targets: ['localhost:9093']
-
-# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
-rule_files:
-  # - "first_rules.yml"
-  # - "second_rules.yml"
-
-# A scrape configuration containing exactly one endpoint to scrape:
-# Here it's Prometheus itself.
 scrape_configs:
-  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
   - job_name: 'prometheus'
-
-    # Override the global default and scrape targets from this job every 5 seconds.
     scrape_interval: 5s
     scrape_timeout: 5s
-
-    # metrics_path defaults to '/metrics'
-    # scheme defaults to 'http'.
-
+    metrics_path: /prometheus/metrics
     static_configs:
       - targets: ['localhost:9090']
 
-  - job_name: node
-    # If prometheus-node-exporter is installed, grab stats about the local
-    # machine by default.
+  - job_name: linux
     static_configs:
-      - targets: ['localhost:9100']
+      - targets:
+               - 'LeonidVagulin-3:9100'
+               - 'LeonidVagulin-2:9100'
+               - 'LeonidVagulin-1:9100'
+                
+  - job_name: bind9
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-1:9119'
+               - 'LeonidVagulin-2:9119'
+               - 'LeonidVagulin-3:9119'
+                
+  - job_name: mysql
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-3:9104'
+               - 'LeonidVagulin-2:9104'
+                
+  - job_name: nginx
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-3:9113'
+               - 'LeonidVagulin-2:9113'
+               - 'LeonidVagulin-1:9113'
+                
+  - job_name: influxbd
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-1:9424'
+        
+  - job_name: haproxy
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-3:9101'
+               - 'LeonidVagulin-2:9101'
+        
+  - job_name: keepalived
+    static_configs:
+      - targets:
+               - 'LeonidVagulin-3:9165'
+               - 'LeonidVagulin-2:9165'
+        

changed: [LeonidVagulin-1]

TASK [prometheus : copy prometheus service conf] *******************************
--- before: /etc/default/prometheus
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpgua8i45_/prometheus
@@ -1,57 +1 @@
-# Set the command-line arguments to pass to the server.
-ARGS=""
-
-# Prometheus supports the following options:
-#  --config.file="/etc/prometheus/prometheus.yml"
-#                             Prometheus configuration file path.
-#  --web.listen-address="0.0.0.0:9090"
-#                             Address to listen on for UI, API, and telemetry.
-#  --web.read-timeout=5m      Maximum duration before timing out read of the
-#                             request, and closing idle connections.
-#  --web.max-connections=512  Maximum number of simultaneous connections.
-#  --web.external-url=<URL>   The URL under which Prometheus is externally
-#                             reachable (for example, if Prometheus is served
-#                             via a reverse proxy). Used for generating
-#                             relative and absolute links back to Prometheus
-#                             itself. If the URL has a path portion, it will
-#                             be used to prefix all HTTP endpoints served by
-#                             Prometheus. If omitted, relevant URL components
-#                             will be derived automatically.
-#  --web.route-prefix=<path>  Prefix for the internal routes of web endpoints.
-#                             Defaults to path of --web.external-url.
-#  --web.local-assets="/usr/share/prometheus/web/"
-#                             Path to static asset/templates directory.
-#  --web.user-assets=<path>   Path to static asset directory, available at
-#                             /user.
-#  --web.enable-lifecycle     Enable shutdown and reload via HTTP request.
-#  --web.enable-admin-api     Enables API endpoints for admin control actions.
-#  --web.console.templates="/etc/prometheus/consoles"
-#                             Path to the console template directory,
-#                             available at /consoles.
-#  --web.console.libraries="/etc/prometheus/console_libraries"
-#                             Path to the console library directory.
-#  --storage.tsdb.path="/var/lib/prometheus/metrics2/"
-#                             Base path for metrics storage.
-#  --storage.tsdb.min-block-duration=2h
-#                             Minimum duration of a data block before being
-#                             persisted.
-#  --storage.tsdb.max-block-duration=<duration>
-#                             Maximum duration compacted blocks may span.
-#                             (Defaults to 10% of the retention period)
-#  --storage.tsdb.retention=15d
-#                             How long to retain samples in the storage.
-#  --storage.tsdb.use-lockfile
-#                             Create a lockfile in data directory.
-#  --alertmanager.notification-queue-capacity=10000
-#                             The capacity of the queue for pending alert
-#                             manager notifications.
-#  --alertmanager.timeout=10s
-#                             Timeout for sending alerts to Alertmanager.
-#  --query.lookback-delta=5m  The delta difference allowed for retrieving
-#                             metrics during expression evaluations.
-#  --query.timeout=2m         Maximum time a query may take before being
-#                             aborted.
-#  --query.max-concurrency=20
-#                             Maximum number of queries executed concurrently.
-#  --log.level=info           Only log messages with the given severity or
-#                             above. One of: [debug, info, warn, error]
+ARGS="--web.external-url=http://193.40.156.86:10380/prometheus"

changed: [LeonidVagulin-1]

TASK [docker : Install docker] *************************************************
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base libidn11 pigz python3-websocket runc
  ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io libidn11 pigz python3-docker
  python3-websocket runc ubuntu-fan
0 upgraded, 10 newly installed, 0 to remove and 130 not upgraded.
changed: [LeonidVagulin-1]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-1]

TASK [docker : Log into DockerHub] *********************************************
changed: [LeonidVagulin-1]

TASK [grafana : Create folders for grafana] ************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/dashboards",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-1] => (item=dashboards)
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/datasources",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-1] => (item=datasources)

TASK [grafana : grafana-server template confs] *********************************
changed: [LeonidVagulin-1]

TASK [grafana : grafana-server datasources confs] ******************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp226vxw2q/datasource.yaml
@@ -0,0 +1,44 @@
+apiVersion: 1
+
+deleteDatasources:
+  - name: Prometheus
+    orgId: 1
+
+datasources:
+  - name: Prometheus
+    type: prometheus
+    access: proxy
+    orgId: 1
+    #uid: my_unique_uid
+    url: http://LeonidVagulin-1:9090/prometheus
+    password:
+    user:
+    database:
+    isDefault: true
+    version: 1
+    editable: false
+
+  - name: InfluxDB-latency
+    type: influxdb
+    access: proxy
+    orgId: 1
+    #uid: my_unique_uid
+    url: http://LeonidVagulin-1:8086
+    password:
+    user:
+    database: latency
+    isDefault: false
+    version: 1
+    editable: false
+
+  - name: InfluxDB-telegraf
+    type: influxdb
+    access: proxy
+    orgId: 1
+    url: http://LeonidVagulin-1:8086
+    password:
+    user:
+    database: telegraf
+    isDefault: false
+    version: 1
+    editable: false

changed: [LeonidVagulin-1]

TASK [grafana : grafana-server json confs] *************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp4to9o535/dashboards.yaml
@@ -0,0 +1,9 @@
+apiVersion: 1
+
+providers:
+  - name: 'default'
+    folder: ''
+    type: file
+    options:
+      path: /etc/grafana/provisioning/dashboards
+

changed: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/grafana/files/main.json
@@ -0,0 +1,1161 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": "-- Grafana --",
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "target": {
+          "limit": 100,
+          "matchAny": false,
+          "tags": [],
+          "type": "dashboard"
+        },
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "links": [],
+  "liveNow": false,
+  "panels": [
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 3,
+        "x": 0,
+        "y": 0
+      },
+      "id": 24,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "influxdb_exporter_stats_query_success",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "influxdb_exporter_stats_query_success",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 1,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 0,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 3,
+        "x": 3,
+        "y": 0
+      },
+      "id": 6,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "text": {},
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "exemplar": true,
+          "expr": "mysql_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 1,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 0,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 6,
+        "x": 6,
+        "y": 0
+      },
+      "id": 4,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "text": {},
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "exemplar": true,
+          "expr": "nginx_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "nginx",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 6,
+        "x": 12,
+        "y": 0
+      },
+      "id": 2,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "text": {},
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "exemplar": true,
+          "expr": "bind_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "Bind",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 4,
+        "x": 18,
+        "y": 0
+      },
+      "id": 10,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "haproxy_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "haproxy",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 4,
+        "w": 2,
+        "x": 22,
+        "y": 0
+      },
+      "id": 14,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "keepalived_vrrp_state",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "keepalived_vrrp_state",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 3,
+        "w": 18,
+        "x": 0,
+        "y": 4
+      },
+      "id": 12,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "haproxy_server_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "haproxy_server_up",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 3,
+        "w": 4,
+        "x": 18,
+        "y": 4
+      },
+      "id": 16,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "keepalived_up",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "keepalived_up",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 7
+      },
+      "id": 22,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "nginx_http_requests_total",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "nginx_http_requests_total",
+      "type": "timeseries"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 7
+      },
+      "id": 18,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "bind_resolver_queries_total",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "bind_resolver_queries_total",
+      "type": "timeseries"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 15
+      },
+      "id": 20,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "mysql_global_status_commands_total",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql_global_status_commands_total",
+      "type": "timeseries"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 15
+      },
+      "id": 26,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "influxdb_write_write_ok",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "influxdb_write_write_ok)",
+      "type": "timeseries"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 23
+      },
+      "id": 8,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "exemplar": true,
+          "expr": "node_cpu_seconds_total",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "CPULoad",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "P29B7D75015DE2922"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 23
+      },
+      "id": 28,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom"
+        },
+        "tooltip": {
+          "mode": "single"
+        }
+      },
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "P29B7D75015DE2922"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "$__interval"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "dst"
+              ],
+              "type": "tag"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "latency",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "rtt"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "mean"
+              }
+            ]
+          ],
+          "tags": []
+        }
+      ],
+      "title": "pinger",
+      "type": "timeseries"
+    }
+  ],
+  "refresh": false,
+  "schemaVersion": 34,
+  "style": "dark",
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-5m",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "",
+  "title": "New dashboard",
+  "uid": "dhBoA1pnz",
+  "version": 1,
+  "weekStart": ""
+}

changed: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/grafana/files/mysql.json
@@ -0,0 +1,326 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": "-- Grafana --",
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "target": {
+          "limit": 100,
+          "matchAny": false,
+          "tags": [],
+          "type": "dashboard"
+        },
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "links": [],
+  "liveNow": false,
+  "panels": [
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 1,
+                  "text": "READ/WRITE"
+                },
+                "1": {
+                  "index": 0,
+                  "text": "READ"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "blue",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 7,
+        "x": 0,
+        "y": 0
+      },
+      "id": 4,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "mysql_global_variables_read_only",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql_global_variables_read_only",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 0,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 1,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 6,
+        "x": 7,
+        "y": 0
+      },
+      "id": 8,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "exemplar": true,
+          "expr": "mysql_slave_status_slave_sql_running",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql_slave_status_slave_io_running",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "index": 1,
+                  "text": "down"
+                },
+                "1": {
+                  "index": 0,
+                  "text": "up"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "red",
+                "value": null
+              },
+              {
+                "color": "green",
+                "value": 0.5
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 5,
+        "w": 6,
+        "x": 13,
+        "y": 0
+      },
+      "id": 6,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "mysql_slave_status_slave_io_running",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql_slave_status_slave_io_running",
+      "type": "stat"
+    },
+    {
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 9,
+        "w": 12,
+        "x": 0,
+        "y": 5
+      },
+      "id": 2,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "textMode": "auto"
+      },
+      "pluginVersion": "8.3.3",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "exemplar": true,
+          "expr": "mysql_global_variables_server_id\n",
+          "interval": "",
+          "legendFormat": "",
+          "refId": "A"
+        }
+      ],
+      "title": "mysql_global_variables_server_id",
+      "type": "stat"
+    }
+  ],
+  "schemaVersion": 34,
+  "style": "dark",
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-5m",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "",
+  "title": "mySql",
+  "uid": "zumOpJpnz",
+  "version": 1,
+  "weekStart": ""
+}

changed: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/grafana/files/syslog.json
@@ -0,0 +1,992 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": "-- Grafana --",
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "target": {
+          "limit": 100,
+          "matchAny": false,
+          "tags": [],
+          "type": "dashboard"
+        },
+        "type": "dashboard"
+      }
+    ]
+  },
+  "description": "Telegraf / InfluxDB / Grafana as syslog receiver",
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "gnetId": 12433,
+  "graphTooltip": 0,
+  "id": 4,
+  "iteration": 1637516166762,
+  "links": [],
+  "liveNow": false,
+  "panels": [
+    {
+      "aliasColors": {},
+      "bars": true,
+      "dashLength": 10,
+      "dashes": false,
+      "datasource": "InfluxDB-telegraf",
+      "decimals": 0,
+      "fill": 1,
+      "fillGradient": 0,
+      "gridPos": {
+        "h": 7,
+        "w": 24,
+        "x": 0,
+        "y": 0
+      },
+      "hiddenSeries": false,
+      "id": 10,
+      "interval": "",
+      "legend": {
+        "alignAsTable": true,
+        "avg": true,
+        "current": false,
+        "max": true,
+        "min": false,
+        "rightSide": true,
+        "show": true,
+        "sort": null,
+        "sortDesc": null,
+        "total": true,
+        "values": true
+      },
+      "lines": false,
+      "linewidth": 1,
+      "links": [],
+      "nullPointMode": "connected",
+      "options": {
+        "alertThreshold": true
+      },
+      "percentage": false,
+      "pluginVersion": "8.2.5",
+      "pointradius": 2,
+      "points": false,
+      "renderer": "flot",
+      "seriesOverrides": [
+        {
+          "alias": "Info",
+          "color": "rgb(80, 80, 80)",
+          "stack": "A"
+        },
+        {
+          "alias": "Notice",
+          "color": "rgb(182, 182, 182)",
+          "stack": "A"
+        },
+        {
+          "alias": "Warning",
+          "color": "#E0B400",
+          "stack": "A"
+        },
+        {
+          "alias": "Error",
+          "color": "#FF780A",
+          "stack": "A"
+        },
+        {
+          "alias": "Critical",
+          "color": "#E02F44",
+          "stack": "A"
+        },
+        {
+          "alias": "Alert",
+          "color": "#8F3BB8",
+          "stack": "A"
+        },
+        {
+          "alias": "Emergency",
+          "color": "#8F3BB8",
+          "stack": "A"
+        }
+      ],
+      "spaceLength": 10,
+      "stack": false,
+      "steppedLine": false,
+      "targets": [
+        {
+          "alias": "Info",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "info"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Notice",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "B",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "notice"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Warning",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "D",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "warning"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Error",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "C",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "err"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Critical",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "E",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "crit"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Alert",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "F",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "alert"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Emergency",
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "G",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "emerg"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "thresholds": [],
+      "timeFrom": null,
+      "timeRegions": [],
+      "timeShift": null,
+      "title": "syslog count",
+      "tooltip": {
+        "shared": true,
+        "sort": 0,
+        "value_type": "individual"
+      },
+      "type": "graph",
+      "xaxis": {
+        "buckets": null,
+        "mode": "time",
+        "name": null,
+        "show": true,
+        "values": []
+      },
+      "yaxes": [
+        {
+          "decimals": 0,
+          "format": "none",
+          "label": "Messages / min",
+          "logBase": 1,
+          "max": null,
+          "min": null,
+          "show": true
+        },
+        {
+          "format": "short",
+          "label": null,
+          "logBase": 1,
+          "max": null,
+          "min": null,
+          "show": false
+        }
+      ],
+      "yaxis": {
+        "align": false,
+        "alignLevel": null
+      }
+    },
+    {
+      "datasource": "InfluxDB-telegraf",
+      "description": "",
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "custom": {
+            "align": "left",
+            "displayMode": "auto",
+            "filterable": false
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "dark-purple",
+                "value": null
+              },
+              {
+                "color": "dark-red",
+                "value": 2
+              },
+              {
+                "color": "dark-orange",
+                "value": 3
+              },
+              {
+                "color": "dark-yellow",
+                "value": 4
+              },
+              {
+                "color": "rgb(150, 150, 150)",
+                "value": 5
+              },
+              {
+                "color": "rgb(51, 51, 51)",
+                "value": 6
+              },
+              {
+                "color": "rgb(5, 5, 5)",
+                "value": 7
+              }
+            ]
+          }
+        },
+        "overrides": [
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "severity_code"
+            },
+            "properties": [
+              {
+                "id": "mappings",
+                "value": [
+                  {
+                    "options": {
+                      "0": {
+                        "text": "Emergency"
+                      },
+                      "1": {
+                        "text": "Alert"
+                      },
+                      "2": {
+                        "text": "Critical"
+                      },
+                      "3": {
+                        "text": "Error"
+                      },
+                      "4": {
+                        "text": "Warning"
+                      },
+                      "5": {
+                        "text": "Notice"
+                      },
+                      "6": {
+                        "text": "Info"
+                      },
+                      "7": {
+                        "text": "Debug"
+                      }
+                    },
+                    "type": "value"
+                  }
+                ]
+              },
+              {
+                "id": "custom.displayMode",
+                "value": "color-background"
+              },
+              {
+                "id": "custom.width",
+                "value": 119
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Time"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 163
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "hostname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 194
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "appname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 264
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 24,
+        "w": 24,
+        "x": 0,
+        "y": 7
+      },
+      "id": 12,
+      "options": {
+        "showHeader": true,
+        "sortBy": [
+          {
+            "desc": true,
+            "displayName": "Time"
+          }
+        ]
+      },
+      "pluginVersion": "8.2.5",
+      "targets": [
+        {
+          "groupBy": [
+            {
+              "params": [
+                "hostname"
+              ],
+              "type": "tag"
+            },
+            {
+              "params": [
+                "appname"
+              ],
+              "type": "tag"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "table",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              }
+            ],
+            [
+              {
+                "params": [
+                  "message"
+                ],
+                "type": "field"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "timeFrom": null,
+      "timeShift": null,
+      "title": "Syslog Messages",
+      "type": "table"
+    }
+  ],
+  "refresh": "5s",
+  "schemaVersion": 32,
+  "style": "dark",
+  "tags": [],
+  "templating": {
+    "list": [
+      {
+        "allValue": "",
+        "current": {
+          "selected": false,
+          "text": "All",
+          "value": "$__all"
+        },
+        "datasource": "InfluxDB-telegraf",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "description": null,
+        "error": null,
+        "hide": 0,
+        "includeAll": true,
+        "label": "Appname",
+        "multi": true,
+        "name": "appname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "refresh": 2,
+        "regex": "",
+        "skipUrlSync": false,
+        "sort": 1,
+        "tagValuesQuery": "",
+        "tagsQuery": "",
+        "type": "query",
+        "useTags": false
+      },
+      {
+        "allValue": "",
+        "current": {
+          "selected": false,
+          "text": "All",
+          "value": "$__all"
+        },
+        "datasource": "InfluxDB-telegraf",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "description": null,
+        "error": null,
+        "hide": 0,
+        "includeAll": true,
+        "label": "Hostname",
+        "multi": true,
+        "name": "hostname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "refresh": 2,
+        "regex": "",
+        "skipUrlSync": false,
+        "sort": 1,
+        "tagValuesQuery": "",
+        "tagsQuery": "",
+        "type": "query",
+        "useTags": false
+      },
+      {
+        "allValue": "",
+        "current": {
+          "selected": false,
+          "text": "All",
+          "value": "$__all"
+        },
+        "datasource": "InfluxDB-telegraf",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "description": null,
+        "error": null,
+        "hide": 0,
+        "includeAll": true,
+        "label": "Severity",
+        "multi": true,
+        "name": "severity",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "refresh": 2,
+        "regex": "",
+        "skipUrlSync": false,
+        "sort": 0,
+        "tagValuesQuery": "",
+        "tagsQuery": "",
+        "type": "query",
+        "useTags": false
+      },
+      {
+        "current": {
+          "selected": false,
+          "text": "",
+          "value": ""
+        },
+        "description": "Querystring",
+        "error": null,
+        "hide": 0,
+        "label": "MessageQuery",
+        "name": "Query",
+        "options": [
+          {
+            "selected": true,
+            "text": "",
+            "value": ""
+          }
+        ],
+        "query": "",
+        "skipUrlSync": false,
+        "type": "textbox"
+      }
+    ]
+  },
+  "time": {
+    "from": "now-1h",
+    "to": "now"
+  },
+  "timepicker": {
+    "refresh_intervals": [
+      "5s",
+      " 10s",
+      " 30s",
+      " 1m",
+      " 5m"
+    ],
+    "time_options": [
+      "5m",
+      "15m",
+      "1h",
+      "6h",
+      "12h",
+      "24h",
+      "2d",
+      "7d",
+      "30d"
+    ]
+  },
+  "timezone": "",
+  "title": "Syslog",
+  "uid": "TIYeHqRgZ",
+  "version": 1
+}

changed: [LeonidVagulin-1]

TASK [grafana : install and run grafana in docker] *****************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [LeonidVagulin-1]

RUNNING HANDLER [influxdb : restart influxdb] **********************************
changed: [LeonidVagulin-1]

RUNNING HANDLER [influxdb_exporter : restart telegraf] *************************
changed: [LeonidVagulin-1]

RUNNING HANDLER [nginx : restart nginx] ****************************************
changed: [LeonidVagulin-1]

RUNNING HANDLER [nginx_exporter : restart prometheus-nginx-exporter] ***********
changed: [LeonidVagulin-1]

RUNNING HANDLER [prometheus : Restart prometheus] ******************************
changed: [LeonidVagulin-1]

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : nginx] ***********************************************************
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx nginx-common nginx-core
0 upgraded, 17 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libfontconfig1 libgd3 libjbig0
  libjpeg-turbo8 libjpeg8 libnginx-mod-http-image-filter
  libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libtiff5
  libwebp6 libxpm4 nginx nginx-common nginx-core
0 upgraded, 17 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [nginx : copy html] *******************************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/nginx/files/index.html
@@ -0,0 +1,8 @@
+<html>
+    <head>
+        <title>LeonidVagulin-1 - Nginx</title>
+    </head>
+    <body>
+        <h1>Nginx running on LeonidVagulin-1</h1>
+    </body>
+</html>

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/nginx/files/index.html
@@ -0,0 +1,8 @@
+<html>
+    <head>
+        <title>LeonidVagulin-1 - Nginx</title>
+    </head>
+    <body>
+        <h1>Nginx running on LeonidVagulin-1</h1>
+    </body>
+</html>

changed: [LeonidVagulin-3]

TASK [nginx : copy default] ****************************************************
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpterrgxgg/default
@@ -1,91 +1,41 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
-
-# Default server configuration
-#
 server {
 	listen 80 default_server;
-	listen [::]:80 default_server;
+	server_name _;
+        
+        large_client_header_buffers 4 16k;
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
+        location / {
+        proxy_pass http://localhost:8001/;
+        }
+	location /node-metrics {
+	 proxy_pass http://localhost:9100/metrics;
+	}
+	location /node_exporter {
+	 proxy_pass http://localhost:9100/metrics;
+}
 
-	root /var/www/html;
+      location /nginx-metrics {
+	 proxy_pass http://localhost:9113/metrics;
+}
+      location /influxdb-metrics {
+	 proxy_pass http://localhost:9424/metrics;
+}
+      location /haproxy-metrics {
+	 proxy_pass http://localhost:9101/metrics;
+}
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
+      location /keepalived-metrics {
+	 proxy_pass http://localhost:9165/metrics;
+}
 
-	server_name _;
+	
+	
+			location /bind-metrics {
+	 proxy_pass http://localhost:9119/metrics;
+}
+        location /mysql-metrics {
+	 proxy_pass http://localhost:9104/metrics;
+}
 
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
 	}
 
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
-}
-
-
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}

changed: [LeonidVagulin-2]
--- before: /etc/nginx/sites-enabled/default
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpgk8vy_i6/default
@@ -1,91 +1,41 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
-
-# Default server configuration
-#
 server {
 	listen 80 default_server;
-	listen [::]:80 default_server;
+	server_name _;
+        
+        large_client_header_buffers 4 16k;
 
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
+        location / {
+        proxy_pass http://localhost:8001/;
+        }
+	location /node-metrics {
+	 proxy_pass http://localhost:9100/metrics;
+	}
+	location /node_exporter {
+	 proxy_pass http://localhost:9100/metrics;
+}
 
-	root /var/www/html;
+      location /nginx-metrics {
+	 proxy_pass http://localhost:9113/metrics;
+}
+      location /influxdb-metrics {
+	 proxy_pass http://localhost:9424/metrics;
+}
+      location /haproxy-metrics {
+	 proxy_pass http://localhost:9101/metrics;
+}
 
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
+      location /keepalived-metrics {
+	 proxy_pass http://localhost:9165/metrics;
+}
 
-	server_name _;
+	
+	
+			location /bind-metrics {
+	 proxy_pass http://localhost:9119/metrics;
+}
+        location /mysql-metrics {
+	 proxy_pass http://localhost:9104/metrics;
+}
 
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
 	}
 
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
-}
-
-
-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}

changed: [LeonidVagulin-3]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [nginx : copy default] ****************************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpfxhd6bju/exporter
@@ -0,0 +1,6 @@
+server {
+	listen 8080 default_server;
+	location = /stub_status{
+		stub_status;
+	}
+}

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpuv63fry3/exporter
@@ -0,0 +1,6 @@
+server {
+	listen 8080 default_server;
+	location = /stub_status{
+		stub_status;
+	}
+}

changed: [LeonidVagulin-3]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [mysql : Make sure mysql-server is installed] *****************************
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libencode-locale-perl libevent-core-2.1-7
  libevent-pthreads-2.1-7 libfcgi-perl libhtml-parser-perl libhtml-tagset-perl
  libhtml-template-perl libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 liburi-perl mecab-ipadic mecab-ipadic-utf8
  mecab-utils mysql-client-8.0 mysql-client-core-8.0 mysql-common
  mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libwww-perl mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libencode-locale-perl libevent-core-2.1-7
  libevent-pthreads-2.1-7 libfcgi-perl libhtml-parser-perl libhtml-tagset-perl
  libhtml-template-perl libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 liburi-perl mecab-ipadic mecab-ipadic-utf8
  mecab-utils mysql-client-8.0 mysql-client-core-8.0 mysql-common mysql-server
  mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 24 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libencode-locale-perl libevent-core-2.1-7
  libevent-pthreads-2.1-7 libfcgi-perl libhtml-parser-perl libhtml-tagset-perl
  libhtml-template-perl libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 liburi-perl mecab-ipadic mecab-ipadic-utf8
  mecab-utils mysql-client-8.0 mysql-client-core-8.0 mysql-common
  mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libwww-perl mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libencode-locale-perl libevent-core-2.1-7
  libevent-pthreads-2.1-7 libfcgi-perl libhtml-parser-perl libhtml-tagset-perl
  libhtml-template-perl libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 liburi-perl mecab-ipadic mecab-ipadic-utf8
  mecab-utils mysql-client-8.0 mysql-client-core-8.0 mysql-common mysql-server
  mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 24 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]

TASK [mysql : Make sure python3-pymysql is installed] **************************
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [mysql : template] ********************************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpig9gbjza/override.cnf
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = 0.0.0.0
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 29

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpt4q1hwu3/override.cnf
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = 0.0.0.0
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 21

changed: [LeonidVagulin-3]

TASK [mysql : Make sure mysql is started] **************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL database] **************************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [mysql : MySQL user] ******************************************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

TASK [mysql : Create user exporter] ********************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [mysql : MySQL user for replication] **************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [mysql : MySQL replica read only mode ON] *********************************
skipping: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

TASK [mysql : MySQL replica read only mode OFF] ********************************
skipping: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [node_exporter : Install node exporters] **********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_backup : Create a directory for mysql backup] **********************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-3]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-2]

TASK [mysql_backup : Create user backup] ***************************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

TASK [mysql_backup : copy my.cnf] **********************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmppk69rc9q/my.cnf
@@ -0,0 +1,5 @@
+[client]
+user=backup
+password=123456
+[mysqldump]
+no_tablespaces

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpj3choq2z/my.cnf
@@ -0,0 +1,5 @@
+[client]
+user=backup
+password=123456
+[mysqldump]
+no_tablespaces

changed: [LeonidVagulin-3]

TASK [mysql_backup : copy cron tab file] ***************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp3b4dynrj/mysql-backup
@@ -0,0 +1 @@
+

changed: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp6kji6lyi/mysql-backup
@@ -0,0 +1,3 @@
+19 17 * * * backup  mysqldump agama > /home/backup/mysql/agama.sql
+30 17 * * * backup  duplicity --no-encryption full /home/backup/mysql/ rsync://LeonidVagulin@backup-server.deez.lv//home/LeonidVagulin/
+35 17 * * * backup  duplicity --no-encryption incremental /home/backup/mysql/ rsync://LeonidVagulin@backup-server.deez.lv//home/LeonidVagulin/

changed: [LeonidVagulin-2]

TASK [rsyslog : copy pinger.service] *******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : Add backup user] ************************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [backup : Create /opt/agama] **********************************************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-2]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-3]

TASK [backup : Install duplicity] **********************************************
The following additional packages will be installed:
  librsync2 python3-bcrypt python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient python3-pip par2
  python-future-doc python-lockfile-doc python3-gssapi
The following NEW packages will be installed:
  duplicity librsync2 python3-bcrypt python3-fasteners python3-future
  python3-lockfile python3-monotonic python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  librsync2 python3-bcrypt python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient python3-pip par2
  python-future-doc python-lockfile-doc python3-gssapi
The following NEW packages will be installed:
  duplicity librsync2 python3-bcrypt python3-fasteners python3-future
  python3-lockfile python3-monotonic python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [backup : template backup server known_hosts] *****************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpvb78j1wo/known_hosts
@@ -0,0 +1,2 @@
+backup-server ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBSne71MCp6CQCHURWe3CLud6vPDkLfL83Oab/giAI7O
+backup-server.deez.lv ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBSne71MCp6CQCHURWe3CLud6vPDkLfL83Oab/giAI7O

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpo266xt50/known_hosts
@@ -0,0 +1,2 @@
+backup-server ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBSne71MCp6CQCHURWe3CLud6vPDkLfL83Oab/giAI7O
+backup-server.deez.lv ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBSne71MCp6CQCHURWe3CLud6vPDkLfL83Oab/giAI7O

changed: [LeonidVagulin-3]

TASK [mysql_exporter : Check if prometheus-mysql-exporter is up to date] *******
The following additional packages will be installed:
  daemon
The following NEW packages will be installed:
  daemon prometheus-mysqld-exporter
0 upgraded, 2 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  daemon
The following NEW packages will be installed:
  daemon prometheus-mysqld-exporter
0 upgraded, 2 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [mysql_exporter : pause] **************************************************
Pausing for 20 seconds
(ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
ok: [LeonidVagulin-3]

TASK [mysql_exporter : copy my.cnf] ********************************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpgolsqwgs/my.cnf
@@ -0,0 +1,3 @@
+[client]
+user=exporter
+password=123456

changed: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpicbmogah/my.cnf
@@ -0,0 +1,3 @@
+[client]
+user=exporter
+password=123456

changed: [LeonidVagulin-2]

TASK [mysql_exporter : copy args for slave metrics] ****************************
--- before: /etc/default/prometheus-mysqld-exporter
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/mysql_exporter/files/prometheus-mysqld-exporter
@@ -1,120 +1 @@
-# By default the connection string will be read from
-# $HOME/my.cnf or from the file specified with the -config.my-cnf parameter.
-
-# To set a connection string from the environment instead, uncomment one of the
-# following lines.
-
-# Using UNIX domain sockets and authentication:
-# DATA_SOURCE_NAME="prometheus:nopassword@unix(/run/mysqld/mysqld.sock)/"
-
-# Using a TCP connection and password authentication:
-# DATA_SOURCE_NAME="login:password@(hostname:port)/dbname"
-
-# Note the user must be granted enough privileges for the exporter to run.
-# Example to create a user to connect with the UNIX socket:
-#
-#  CREATE USER IF NOT EXISTS 'prometheus'@'localhost' IDENTIFIED VIA unix_socket;
-#  GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'prometheus'@'localhost';
-
-# Set the command-line arguments to pass to the exporter.
-# ARGS='-config.my-cnf /etc/mysql/debian.cnf'
-
-# Usage of prometheus-mysqld-exporter:
-#   -collect.auto_increment.columns
-#     	Collect auto_increment columns and max values from information_schema
-#  --exporter.lock_wait_timeout=2
-#       Set a lock_wait_timeout on the connection to avoid long metadata
-#       locking.
-#  --exporter.log_slow_filter
-#       Add a log_slow_filter to avoid slow query logging of scrapes. NOTE: Not
-#       supported by Oracle MySQL.
-#  --collect.heartbeat.database="heartbeat"
-#       Database from where to collect heartbeat data
-#  --collect.heartbeat.table="heartbeat"
-#       Table from where to collect heartbeat data
-#  --collect.info_schema.processlist.min_time=0
-#       Minimum time a thread must be in each state to be counted
-#  --collect.info_schema.tables.databases="*"
-#       The list of databases to collect table stats for, or '*' for all
-#  --collect.perf_schema.eventsstatements.limit=250
-#       Limit the number of events statements digests by response time
-#  --collect.perf_schema.eventsstatements.timelimit=86400
-#       Limit how old the 'last_seen' events statements can be, in seconds
-#  --collect.perf_schema.eventsstatements.digest_text_limit=120
-#       Maximum length of the normalized statement text
-#  --collect.perf_schema.file_instances.filter=".*"
-#       RegEx file_name filter for performance_schema.file_summary_by_instance
-#  --collect.perf_schema.file_instances.remove_prefix="/var/lib/mysql/"
-#       Remove path prefix in performance_schema.file_summary_by_instance
-#  --web.listen-address=":9104"
-#       Address to listen on for web interface and telemetry.
-#  --web.telemetry-path="/metrics"
-#       Path under which to expose metrics.
-#  --config.my-cnf="$HOME/.my.cnf"
-#       Path to .my.cnf file to read MySQL credentials from.
-#  --collect.global_variables
-#       Collect from SHOW GLOBAL VARIABLES
-#  --collect.slave_status
-#       Collect from SHOW SLAVE STATUS
-#  --collect.info_schema.processlist
-#       Collect current thread state counts from the
-#       information_schema.processlist
-#  --collect.info_schema.tables
-#       Collect metrics from information_schema.tables
-#  --collect.info_schema.innodb_tablespaces
-#       Collect metrics from information_schema.innodb_sys_tablespaces
-#  --collect.info_schema.innodb_metrics
-#       Collect metrics from information_schema.innodb_metrics
-#  --collect.auto_increment.columns
-#       Collect auto_increment columns and max values from information_schema
-#  --collect.global_status
-#       Collect from SHOW GLOBAL STATUS
-#  --collect.perf_schema.tableiowaits
-#       Collect metrics from performance_schema.table_io_waits_summary_by_table
-#  --collect.perf_schema.indexiowaits
-#       Collect metrics from
-#       performance_schema.table_io_waits_summary_by_index_usage
-#  --collect.perf_schema.tablelocks
-#       Collect metrics from
-#       performance_schema.table_lock_waits_summary_by_table
-#  --collect.perf_schema.eventsstatements
-#       Collect metrics from
-#       performance_schema.events_statements_summary_by_digest
-#  --collect.perf_schema.eventswaits
-#       Collect metrics from
-#       performance_schema.events_waits_summary_global_by_event_name
-#  --collect.perf_schema.file_events
-#       Collect metrics from performance_schema.file_summary_by_event_name
-#  --collect.perf_schema.file_instances
-#       Collect metrics from performance_schema.file_summary_by_instance
-#  --collect.binlog_size
-#       Collect the current size of all registered binlog files
-#  --collect.info_schema.userstats
-#       If running with userstat=1, set to true to collect user statistics
-#  --collect.info_schema.clientstats
-#       If running with userstat=1, set to true to collect client statistics
-#  --collect.info_schema.tablestats
-#       If running with userstat=1, set to true to collect table statistics
-#  --collect.info_schema.innodb_cmp
-#       Collect metrics from information_schema.innodb_cmp
-#  --collect.info_schema.innodb_cmpmem
-#       Collect metrics from information_schema.innodb_cmpmem
-#  --collect.info_schema.query_response_time
-#       Collect query response time distribution if query_response_time_stats
-#       is ON.
-#  --collect.engine_tokudb_status
-#       Collect from SHOW ENGINE TOKUDB STATUS
-#  --collect.perf_schema.replication_group_member_stats
-#       Collect metrics from performance_schema.replication_group_member_stats
-#  --collect.heartbeat
-#       Collect from heartbeat
-#  --collect.slave_hosts
-#       Scrape information from 'SHOW SLAVE HOSTS'
-#  --collect.engine_innodb_status
-#       Collect from SHOW ENGINE INNODB STATUS
-#  --log.level="info"
-#       Only log messages with the given severity or above. Valid levels:
-#       [debug, info, warn, error, fatal]
-#  --log.format="logger:stderr"
-#       Set the log target and format. Example:
-#       "logger:syslog?appname=bob&local=7" or "logger:stdout?json=true"
+ARGS="--collect.slave_status"

changed: [LeonidVagulin-2]
--- before: /etc/default/prometheus-mysqld-exporter
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/mysql_exporter/files/prometheus-mysqld-exporter
@@ -1,120 +1 @@
-# By default the connection string will be read from
-# $HOME/my.cnf or from the file specified with the -config.my-cnf parameter.
-
-# To set a connection string from the environment instead, uncomment one of the
-# following lines.
-
-# Using UNIX domain sockets and authentication:
-# DATA_SOURCE_NAME="prometheus:nopassword@unix(/run/mysqld/mysqld.sock)/"
-
-# Using a TCP connection and password authentication:
-# DATA_SOURCE_NAME="login:password@(hostname:port)/dbname"
-
-# Note the user must be granted enough privileges for the exporter to run.
-# Example to create a user to connect with the UNIX socket:
-#
-#  CREATE USER IF NOT EXISTS 'prometheus'@'localhost' IDENTIFIED VIA unix_socket;
-#  GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'prometheus'@'localhost';
-
-# Set the command-line arguments to pass to the exporter.
-# ARGS='-config.my-cnf /etc/mysql/debian.cnf'
-
-# Usage of prometheus-mysqld-exporter:
-#   -collect.auto_increment.columns
-#     	Collect auto_increment columns and max values from information_schema
-#  --exporter.lock_wait_timeout=2
-#       Set a lock_wait_timeout on the connection to avoid long metadata
-#       locking.
-#  --exporter.log_slow_filter
-#       Add a log_slow_filter to avoid slow query logging of scrapes. NOTE: Not
-#       supported by Oracle MySQL.
-#  --collect.heartbeat.database="heartbeat"
-#       Database from where to collect heartbeat data
-#  --collect.heartbeat.table="heartbeat"
-#       Table from where to collect heartbeat data
-#  --collect.info_schema.processlist.min_time=0
-#       Minimum time a thread must be in each state to be counted
-#  --collect.info_schema.tables.databases="*"
-#       The list of databases to collect table stats for, or '*' for all
-#  --collect.perf_schema.eventsstatements.limit=250
-#       Limit the number of events statements digests by response time
-#  --collect.perf_schema.eventsstatements.timelimit=86400
-#       Limit how old the 'last_seen' events statements can be, in seconds
-#  --collect.perf_schema.eventsstatements.digest_text_limit=120
-#       Maximum length of the normalized statement text
-#  --collect.perf_schema.file_instances.filter=".*"
-#       RegEx file_name filter for performance_schema.file_summary_by_instance
-#  --collect.perf_schema.file_instances.remove_prefix="/var/lib/mysql/"
-#       Remove path prefix in performance_schema.file_summary_by_instance
-#  --web.listen-address=":9104"
-#       Address to listen on for web interface and telemetry.
-#  --web.telemetry-path="/metrics"
-#       Path under which to expose metrics.
-#  --config.my-cnf="$HOME/.my.cnf"
-#       Path to .my.cnf file to read MySQL credentials from.
-#  --collect.global_variables
-#       Collect from SHOW GLOBAL VARIABLES
-#  --collect.slave_status
-#       Collect from SHOW SLAVE STATUS
-#  --collect.info_schema.processlist
-#       Collect current thread state counts from the
-#       information_schema.processlist
-#  --collect.info_schema.tables
-#       Collect metrics from information_schema.tables
-#  --collect.info_schema.innodb_tablespaces
-#       Collect metrics from information_schema.innodb_sys_tablespaces
-#  --collect.info_schema.innodb_metrics
-#       Collect metrics from information_schema.innodb_metrics
-#  --collect.auto_increment.columns
-#       Collect auto_increment columns and max values from information_schema
-#  --collect.global_status
-#       Collect from SHOW GLOBAL STATUS
-#  --collect.perf_schema.tableiowaits
-#       Collect metrics from performance_schema.table_io_waits_summary_by_table
-#  --collect.perf_schema.indexiowaits
-#       Collect metrics from
-#       performance_schema.table_io_waits_summary_by_index_usage
-#  --collect.perf_schema.tablelocks
-#       Collect metrics from
-#       performance_schema.table_lock_waits_summary_by_table
-#  --collect.perf_schema.eventsstatements
-#       Collect metrics from
-#       performance_schema.events_statements_summary_by_digest
-#  --collect.perf_schema.eventswaits
-#       Collect metrics from
-#       performance_schema.events_waits_summary_global_by_event_name
-#  --collect.perf_schema.file_events
-#       Collect metrics from performance_schema.file_summary_by_event_name
-#  --collect.perf_schema.file_instances
-#       Collect metrics from performance_schema.file_summary_by_instance
-#  --collect.binlog_size
-#       Collect the current size of all registered binlog files
-#  --collect.info_schema.userstats
-#       If running with userstat=1, set to true to collect user statistics
-#  --collect.info_schema.clientstats
-#       If running with userstat=1, set to true to collect client statistics
-#  --collect.info_schema.tablestats
-#       If running with userstat=1, set to true to collect table statistics
-#  --collect.info_schema.innodb_cmp
-#       Collect metrics from information_schema.innodb_cmp
-#  --collect.info_schema.innodb_cmpmem
-#       Collect metrics from information_schema.innodb_cmpmem
-#  --collect.info_schema.query_response_time
-#       Collect query response time distribution if query_response_time_stats
-#       is ON.
-#  --collect.engine_tokudb_status
-#       Collect from SHOW ENGINE TOKUDB STATUS
-#  --collect.perf_schema.replication_group_member_stats
-#       Collect metrics from performance_schema.replication_group_member_stats
-#  --collect.heartbeat
-#       Collect from heartbeat
-#  --collect.slave_hosts
-#       Scrape information from 'SHOW SLAVE HOSTS'
-#  --collect.engine_innodb_status
-#       Collect from SHOW ENGINE INNODB STATUS
-#  --log.level="info"
-#       Only log messages with the given severity or above. Valid levels:
-#       [debug, info, warn, error, fatal]
-#  --log.format="logger:stderr"
-#       Set the log target and format. Example:
-#       "logger:syslog?appname=bob&local=7" or "logger:stdout?json=true"
+ARGS="--collect.slave_status"

changed: [LeonidVagulin-3]

TASK [mysql_exporter : conf prometheus-mysqld-exporter] ************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [pinger : Add pinger user] ************************************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

TASK [pinger : Install  fping] *************************************************
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]

TASK [pinger : Create /etc/pinger] *********************************************
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "owner": 0,
+    "owner": 1001,
     "path": "/etc/pinger",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-3]
--- before
+++ after
@@ -1,5 +1,5 @@
 {
-    "owner": 0,
+    "owner": 1001,
     "path": "/etc/pinger",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-2]

TASK [pinger : copy pinger.conf] ***********************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.conf
@@ -0,0 +1,3 @@
+database_url=http://localhost:8086
+database_name=latency
+targets=google.com,cloudflare.com,twitter.com

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.conf
@@ -0,0 +1,3 @@
+database_url=http://localhost:8086
+database_name=latency
+targets=google.com,cloudflare.com,twitter.com

changed: [LeonidVagulin-3]

TASK [pinger : copy pinger.sh] *************************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.sh
@@ -0,0 +1,26 @@
+#!/bin/bash
+
+# Script contains several (more than 1) security issues.
+# Find them and fix them to get bonus on exam.
+# Problem example: SQL injection.
+
+for t in database_url database_name targets; do
+  if ! grep -q "^${t}=" /etc/pinger/pinger.conf; then
+    logger "$0 Failed to get $t from config"
+    exit 1
+  fi
+done
+
+which fping > /dev/null || (logger "fping not found"; exit 1)
+
+db_url=$(grep "^database_url=" /etc/pinger/pinger.conf | sed 's/^.*=//')
+db_name=$(grep "^database_name=" /etc/pinger/pinger.conf | sed 's/^.*=//')
+targets=$(grep "^targets=" /etc/pinger/pinger.conf | sed 's/^.*=//' | sed 's/\(,\|;\)/ /g')
+
+curl -i -XPOST "${db_url}/query" --data-urlencode "q=CREATE DATABASE $db_name" 1>/dev/null 2>/dev/null
+
+while true; do
+  result=$(fping -C1 -q $targets 2>&1 | awk -v db=$db_name '{print db",dst="$1" rtt="$3}')
+  curl -i -XPOST "${db_url}/write?db=$db_name" --data-binary "$result" 1>/dev/null 2>/dev/null
+ sleep 1
+done

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.sh
@@ -0,0 +1,26 @@
+#!/bin/bash
+
+# Script contains several (more than 1) security issues.
+# Find them and fix them to get bonus on exam.
+# Problem example: SQL injection.
+
+for t in database_url database_name targets; do
+  if ! grep -q "^${t}=" /etc/pinger/pinger.conf; then
+    logger "$0 Failed to get $t from config"
+    exit 1
+  fi
+done
+
+which fping > /dev/null || (logger "fping not found"; exit 1)
+
+db_url=$(grep "^database_url=" /etc/pinger/pinger.conf | sed 's/^.*=//')
+db_name=$(grep "^database_name=" /etc/pinger/pinger.conf | sed 's/^.*=//')
+targets=$(grep "^targets=" /etc/pinger/pinger.conf | sed 's/^.*=//' | sed 's/\(,\|;\)/ /g')
+
+curl -i -XPOST "${db_url}/query" --data-urlencode "q=CREATE DATABASE $db_name" 1>/dev/null 2>/dev/null
+
+while true; do
+  result=$(fping -C1 -q $targets 2>&1 | awk -v db=$db_name '{print db",dst="$1" rtt="$3}')
+  curl -i -XPOST "${db_url}/write?db=$db_name" --data-binary "$result" 1>/dev/null 2>/dev/null
+ sleep 1
+done

changed: [LeonidVagulin-3]

TASK [pinger : copy pinger.service] ********************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.service
@@ -0,0 +1,11 @@
+[Unit]
+Description=pinger
+Documentation=pinger
+After=network-online.target
+
+[Service]
+User=pinger
+ExecStart=/usr/local/bin/pinger
+
+[Install]
+WantedBy=multi-user.target

changed: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/pinger/files/pinger.service
@@ -0,0 +1,11 @@
+[Unit]
+Description=pinger
+Documentation=pinger
+After=network-online.target
+
+[Service]
+User=pinger
+ExecStart=/usr/local/bin/pinger
+
+[Install]
+WantedBy=multi-user.target

changed: [LeonidVagulin-2]

TASK [pinger : daemon reload] **************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : pinger service start and conf] **********************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

RUNNING HANDLER [nginx : restart nginx] ****************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

RUNNING HANDLER [nginx_exporter : restart prometheus-nginx-exporter] ***********
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

RUNNING HANDLER [mysql : Restart MySQL source] *********************************
skipping: [LeonidVagulin-2] => (item=stopreplica) 
skipping: [LeonidVagulin-2] => (item=resetprimary) 
ok: [LeonidVagulin-3] => (item=stopreplica)
changed: [LeonidVagulin-3] => (item=resetprimary)

RUNNING HANDLER [mysql : Restart MySQL replica] ********************************
skipping: [LeonidVagulin-3] => (item=stopreplica) 
skipping: [LeonidVagulin-3] => (item=changeprimary) 
skipping: [LeonidVagulin-3] => (item=resetreplica) 
skipping: [LeonidVagulin-3] => (item=startreplica) 
ok: [LeonidVagulin-2] => (item=stopreplica)
changed: [LeonidVagulin-2] => (item=changeprimary)
changed: [LeonidVagulin-2] => (item=resetreplica)
changed: [LeonidVagulin-2] => (item=startreplica)

RUNNING HANDLER [mysql_backup : restart mysql] *********************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

RUNNING HANDLER [mysql_exporter : restart prometheus-mysqld-exporter] **********
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

PLAY [Apps] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : Install docker] *************************************************
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base libidn11 pigz python3-websocket runc
  ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io libidn11 pigz python3-docker
  python3-websocket runc ubuntu-fan
0 upgraded, 10 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base libidn11 pigz python3-websocket runc
  ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io libidn11 pigz python3-docker
  python3-websocket runc ubuntu-fan
0 upgraded, 10 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [docker : Log into DockerHub] *********************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [agama : Create /opt/agama] ***********************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-3]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [LeonidVagulin-2]

TASK [agama : Download agama for Docker] ***************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [agama : build agama for docker] ******************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [agama : install and run agama in docker] *********************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

[DEPRECATION WARNING]: The container_default_behavior option will change its 
default value from "compatibility" to "no_defaults" in community.docker 2.0.0. 
To remove this warning, please specify an explicit value for it now. This 
feature will be removed from community.docker in version 2.0.0. Deprecation 
warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.
changed: [LeonidVagulin-2]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [LeonidVagulin-3]

TASK [agama : install and run agama in docker] *********************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [LeonidVagulin-3]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [LeonidVagulin-2]

PLAY [Keepalive and HA proxy] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived : install keepalived] *****************************************
The following additional packages will be installed:
  ipvsadm libmysqlclient21 libnl-3-200 libnl-genl-3-200 libsensors-config
  libsensors5 libsnmp-base libsnmp35
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libmysqlclient21 libnl-3-200 libnl-genl-3-200
  libsensors-config libsensors5 libsnmp-base libsnmp35
0 upgraded, 9 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  ipvsadm libmysqlclient21 libnl-3-200 libnl-genl-3-200 libsensors-config
  libsensors5 libsnmp-base libsnmp35
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libmysqlclient21 libnl-3-200 libnl-genl-3-200
  libsensors-config libsensors5 libsnmp-base libsnmp35
0 upgraded, 9 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [keepalived : copy script] ************************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/keepalived/templates/script88
@@ -0,0 +1,3 @@
+#!/bin/bash
+
+ss -ntl | grep -q ':88 '

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/keepalived/templates/script88
@@ -0,0 +1,3 @@
+#!/bin/bash
+
+ss -ntl | grep -q ':88 '

changed: [LeonidVagulin-3]

TASK [keepalived : Template keepalived.conf] ***********************************
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpj2raw22a/keepalived.conf
@@ -0,0 +1,27 @@
+global_defs {
+    enable_script_security
+    script_user keepalived_script
+}
+
+vrrp_script check_haproxy {                 
+    script "/usr/bin/script88" 
+    weight 20                              
+    interval 1               
+}
+vrrp_instance XXX {             
+    interface ens3
+    virtual_router_id 1
+    priority 100
+        
+    advert_int 1                            
+    virtual_ipaddress {                     
+        192.168.100.29/24                   
+    }
+    unicast_peer {                          
+                     192.168.42.21
+                                   
+    }
+    track_script {
+        check_haproxy
+    }
+}

changed: [LeonidVagulin-2]
--- before
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpvy7tvvmm/keepalived.conf
@@ -0,0 +1,27 @@
+global_defs {
+    enable_script_security
+    script_user keepalived_script
+}
+
+vrrp_script check_haproxy {                 
+    script "/usr/bin/script88" 
+    weight 20                              
+    interval 1               
+}
+vrrp_instance XXX {             
+    interface ens3
+    virtual_router_id 1
+        priority 99
+        
+    advert_int 1                            
+    virtual_ipaddress {                     
+        192.168.100.29/24                   
+    }
+    unicast_peer {                          
+                                   192.168.42.29
+                     
+    }
+    track_script {
+        check_haproxy
+    }
+}

changed: [LeonidVagulin-3]

TASK [keepalived : conf keepalived] ********************************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

TASK [haproxy : install haproxy] ***********************************************
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [haproxy : haproxy service start and conf] ********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : Template haproxy.cfg] ******************************************
--- before: /etc/haproxy/haproxy.cfg
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpid2xma56/haproxy.cfg
@@ -2,29 +2,18 @@
 	log /dev/log	local0
 	log /dev/log	local1 notice
 	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
 	user haproxy
 	group haproxy
 	daemon
-
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
-
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
 
 defaults
 	log	global
 	mode	http
 	option	httplog
 	option	dontlognull
-        timeout connect 5000
-        timeout client  50000
-        timeout server  50000
+          timeout connect 5000
+          timeout client  50000
+          timeout server  50000
 	errorfile 400 /etc/haproxy/errors/400.http
 	errorfile 403 /etc/haproxy/errors/403.http
 	errorfile 408 /etc/haproxy/errors/408.http
@@ -32,3 +21,12 @@
 	errorfile 502 /etc/haproxy/errors/502.http
 	errorfile 503 /etc/haproxy/errors/503.http
 	errorfile 504 /etc/haproxy/errors/504.http
+
+listen my_ha_frontend
+    bind *:88
+    stats enable
+    stats uri /stats
+    server docker1 LeonidVagulin-3:8001 check
+    server docker2 LeonidVagulin-2:8001 check
+    server docker3 LeonidVagulin-3:8002 check
+    server docker4 LeonidVagulin-2:8002 check

changed: [LeonidVagulin-3]
--- before: /etc/haproxy/haproxy.cfg
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp6gssjtol/haproxy.cfg
@@ -2,29 +2,18 @@
 	log /dev/log	local0
 	log /dev/log	local1 notice
 	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
 	user haproxy
 	group haproxy
 	daemon
-
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
-
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
 
 defaults
 	log	global
 	mode	http
 	option	httplog
 	option	dontlognull
-        timeout connect 5000
-        timeout client  50000
-        timeout server  50000
+          timeout connect 5000
+          timeout client  50000
+          timeout server  50000
 	errorfile 400 /etc/haproxy/errors/400.http
 	errorfile 403 /etc/haproxy/errors/403.http
 	errorfile 408 /etc/haproxy/errors/408.http
@@ -32,3 +21,12 @@
 	errorfile 502 /etc/haproxy/errors/502.http
 	errorfile 503 /etc/haproxy/errors/503.http
 	errorfile 504 /etc/haproxy/errors/504.http
+
+listen my_ha_frontend
+    bind *:88
+    stats enable
+    stats uri /stats
+    server docker1 LeonidVagulin-3:8001 check
+    server docker2 LeonidVagulin-2:8001 check
+    server docker3 LeonidVagulin-3:8002 check
+    server docker4 LeonidVagulin-2:8002 check

changed: [LeonidVagulin-2]

TASK [haproxy_exporter : haproxy exporter] *************************************
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-2]
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 138 not upgraded.
changed: [LeonidVagulin-3]

TASK [haproxy_exporter : copy conf for ha-exporter] ****************************
--- before: /etc/default/prometheus-haproxy-exporter
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmpzo8dgm4z/prometheus-haproxy-exporter
@@ -1,35 +1 @@
-# Set the command-line arguments to pass to the server.
-# Due to shell scaping, to pass backslashes for regexes, you need to double
-# them (\\d for \d). If running under systemd, you need to double them again
-# (\\\\d to mean \d), and escape newlines too.
-ARGS=""
-
-# Prometheus-haproxy-exporter supports the following options:
-#
-#  --web.listen-address=":9101"
-#    Address to listen on for web interface and telemetry.
-#  --web.telemetry-path="/metrics"
-#    Path under which to expose metrics.
-#  --haproxy.scrape-uri="http://localhost/;csv"
-#    URI on which to scrape HAProxy.
-#  --haproxy.ssl-verify
-#    Flag that enables SSL certificate verification for the scrape URI
-#  --haproxy.server-metric-fields="2,3,4,5,6,7,8,9,13,14,15,16,17,18,21,24,33,35,38,39,40,41,42,43,44"
-#    Comma-separated list of exported server metrics. See
-#    http://cbonte.github.io/haproxy-dconv/configuration-1.5.html#9.1
-#  --haproxy.timeout=5s
-#    Timeout for trying to get stats from HAProxy.
-#  --haproxy.pid-file=""
-#    Path to HAProxy pid file.
-#
-#    If provided, the standard process metrics get exported for the HAProxy
-#    process, prefixed with 'haproxy_process_...'. The haproxy_process exporter
-#    needs to have read access to files owned by the HAProxy process. Depends
-#    on the availability of /proc.
-#    https://prometheus.io/docs/instrumenting/writing_clientlibs/#process-metrics.
-#  --log.level="info"
-#    Only log messages with the given severity or above.
-#    Valid levels: [debug, info, warn, error, fatal]
-#  --log.format="logger:stderr"
-#    Set the log target and format. Example:
-#    "logger:syslog?appname=bob&local=7" or "logger:stdout?json=true"
+ARGS="--haproxy.scrape-uri=http://localhost:88/stats;csv"

changed: [LeonidVagulin-2]
--- before: /etc/default/prometheus-haproxy-exporter
+++ after: /home/whoops/.ansible/tmp/ansible-local-47225zkbfxix5/tmp62gv1lkx/prometheus-haproxy-exporter
@@ -1,35 +1 @@
-# Set the command-line arguments to pass to the server.
-# Due to shell scaping, to pass backslashes for regexes, you need to double
-# them (\\d for \d). If running under systemd, you need to double them again
-# (\\\\d to mean \d), and escape newlines too.
-ARGS=""
-
-# Prometheus-haproxy-exporter supports the following options:
-#
-#  --web.listen-address=":9101"
-#    Address to listen on for web interface and telemetry.
-#  --web.telemetry-path="/metrics"
-#    Path under which to expose metrics.
-#  --haproxy.scrape-uri="http://localhost/;csv"
-#    URI on which to scrape HAProxy.
-#  --haproxy.ssl-verify
-#    Flag that enables SSL certificate verification for the scrape URI
-#  --haproxy.server-metric-fields="2,3,4,5,6,7,8,9,13,14,15,16,17,18,21,24,33,35,38,39,40,41,42,43,44"
-#    Comma-separated list of exported server metrics. See
-#    http://cbonte.github.io/haproxy-dconv/configuration-1.5.html#9.1
-#  --haproxy.timeout=5s
-#    Timeout for trying to get stats from HAProxy.
-#  --haproxy.pid-file=""
-#    Path to HAProxy pid file.
-#
-#    If provided, the standard process metrics get exported for the HAProxy
-#    process, prefixed with 'haproxy_process_...'. The haproxy_process exporter
-#    needs to have read access to files owned by the HAProxy process. Depends
-#    on the availability of /proc.
-#    https://prometheus.io/docs/instrumenting/writing_clientlibs/#process-metrics.
-#  --log.level="info"
-#    Only log messages with the given severity or above.
-#    Valid levels: [debug, info, warn, error, fatal]
-#  --log.format="logger:stderr"
-#    Set the log target and format. Example:
-#    "logger:syslog?appname=bob&local=7" or "logger:stdout?json=true"
+ARGS="--haproxy.scrape-uri=http://localhost:88/stats;csv"

changed: [LeonidVagulin-3]

TASK [haproxy_exporter : conf prometheus-haproxy-exporter] *********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : copy exporter] *************************************
diff skipped: source file size is greater than 104448
changed: [LeonidVagulin-3]
diff skipped: source file size is greater than 104448
changed: [LeonidVagulin-2]

TASK [keepalived_exporter : copy service] **************************************
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/keepalived_exporter/templates/keepalived-exporter.service
@@ -0,0 +1,11 @@
+[Unit]
+Description=keepalived-exporter
+Documentation=keepalived-exporter
+After=network-online.target
+
+[Service]
+User=root
+ExecStart=/usr/local/bin/keepalived-exporter
+
+[Install]
+WantedBy=multi-user.target

changed: [LeonidVagulin-3]
--- before
+++ after: /home/whoops/Desktop/ica0002/ica0002_exam/roles/keepalived_exporter/templates/keepalived-exporter.service
@@ -0,0 +1,11 @@
+[Unit]
+Description=keepalived-exporter
+Documentation=keepalived-exporter
+After=network-online.target
+
+[Service]
+User=root
+ExecStart=/usr/local/bin/keepalived-exporter
+
+[Install]
+WantedBy=multi-user.target

changed: [LeonidVagulin-2]

TASK [keepalived_exporter : daemon reload] *************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : pinger service start and conf] *********************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

RUNNING HANDLER [keepalived : restart keepalived] ******************************
changed: [LeonidVagulin-2]
changed: [LeonidVagulin-3]

RUNNING HANDLER [haproxy : restart haproxy] ************************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

RUNNING HANDLER [haproxy_exporter : restart prometheus-haproxy-exporter] *******
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

RUNNING HANDLER [keepalived_exporter : restart 2] ******************************
skipping: [LeonidVagulin-3] => (item=stopreplica) 
skipping: [LeonidVagulin-3] => (item=changeprimary) 
skipping: [LeonidVagulin-3] => (item=resetreplica) 
skipping: [LeonidVagulin-3] => (item=startreplica) 
ok: [LeonidVagulin-2] => (item=stopreplica)
changed: [LeonidVagulin-2] => (item=changeprimary)
changed: [LeonidVagulin-2] => (item=resetreplica)
changed: [LeonidVagulin-2] => (item=startreplica)

RUNNING HANDLER [keepalived_exporter : Restart pinger] *************************
changed: [LeonidVagulin-3]
changed: [LeonidVagulin-2]

PLAY [DNS records] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [dns_records : add CNAME] *************************************************
changed: [LeonidVagulin-1] => (item={'key': 'grafana', 'value': 'LeonidVagulin-1'})
changed: [LeonidVagulin-1] => (item={'key': 'influxdb', 'value': 'LeonidVagulin-1'})
changed: [LeonidVagulin-1] => (item={'key': 'lb1', 'value': 'LeonidVagulin-3'})
changed: [LeonidVagulin-1] => (item={'key': 'lb2', 'value': 'LeonidVagulin-2'})
changed: [LeonidVagulin-1] => (item={'key': 'mysql1', 'value': 'LeonidVagulin-3'})
changed: [LeonidVagulin-1] => (item={'key': 'mysql2', 'value': 'LeonidVagulin-2'})
changed: [LeonidVagulin-1] => (item={'key': 'ns1', 'value': 'LeonidVagulin-1'})
changed: [LeonidVagulin-1] => (item={'key': 'prometheus', 'value': 'LeonidVagulin-1'})
changed: [LeonidVagulin-1] => (item={'key': 'web1', 'value': 'LeonidVagulin-3'})
changed: [LeonidVagulin-1] => (item={'key': 'web2', 'value': 'LeonidVagulin-2'})

TASK [dns_records : add A records] *********************************************
changed: [LeonidVagulin-1] => (item={'key': 'backup-server', 'value': '192.168.42.156'})

RUNNING HANDLER [dns_records : restart bind] ***********************************
changed: [LeonidVagulin-1]

PLAY RECAP *********************************************************************
LeonidVagulin-1            : ok=70   changed=59   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
LeonidVagulin-2            : ok=95   changed=76   unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   
LeonidVagulin-3            : ok=95   changed=75   unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   

+ ansible-playbook infra.yaml --diff

PLAY [Init] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [init : Update APT cache] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [init : Install iptables-persistent] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [init : Copy iptables.mangle] *********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [init : Copy /etc/iptables/rules.v4] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [init : Fix for ssl] ******************************************************
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [node_exporter : Install node exporters] **********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [rsyslog : copy pinger.service] *******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

PLAY [DNS server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : install bind9] ****************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : bind9 service start and conf] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Template named.conf.options] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : Copy db.deez] *****************************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Copy db.domain.reverse] *******************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Copy local.conf] **************************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [bind : shutdown systemd-resolved] ****************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Template resolv.conf] *********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind_exporter : Install prometheus-bind-exporter] ************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind_exporter : conf prometheus-bind-exporter] ***************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

PLAY [InfluxDB] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-1]

TASK [influxdb : apt_key] ******************************************************
ok: [LeonidVagulin-1]

TASK [influxdb : apt_repository] ***********************************************
ok: [LeonidVagulin-1]

TASK [influxdb : Install  influx and telegraf] *********************************
ok: [LeonidVagulin-1]

TASK [influxdb : influx service start and conf] ********************************
ok: [LeonidVagulin-1]

TASK [influxdb : config telegraf to recieve rsyslog and send to influx] ********
ok: [LeonidVagulin-1]

TASK [influxdb : config influxdb logging msg] **********************************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : install influxdb stats exporter] *********************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : Changing perm of influx db stats exporter] ***********
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : copy service for influx db stats exporter] ***********
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : daemon reload] ***************************************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : prometheus-influxdb-stats-exporterservice start and conf] ***
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Create a directory for influxdb backup] ****************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Install   python3-pip] *********************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Install influxdb for pip] ******************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : create user backup] ************************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : crontab update influxdb_backup] ************************
ok: [LeonidVagulin-1]

TASK [nginx : nginx] ***********************************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy html] *******************************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-1]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-1]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
ok: [LeonidVagulin-1]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
ok: [LeonidVagulin-1]

TASK [prometheus : Install prometheus] *****************************************
ok: [LeonidVagulin-1]

TASK [prometheus : prometheus service start and conf] **************************
ok: [LeonidVagulin-1]

TASK [prometheus : Conf prometheus] ********************************************
ok: [LeonidVagulin-1]

TASK [prometheus : copy prometheus service conf] *******************************
ok: [LeonidVagulin-1]

TASK [docker : Install docker] *************************************************
ok: [LeonidVagulin-1]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-1]

TASK [docker : Log into DockerHub] *********************************************
ok: [LeonidVagulin-1]

TASK [grafana : Create folders for grafana] ************************************
ok: [LeonidVagulin-1] => (item=dashboards)
ok: [LeonidVagulin-1] => (item=datasources)

TASK [grafana : grafana-server template confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server datasources confs] ******************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server json confs] *************************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : install and run grafana in docker] *****************************
ok: [LeonidVagulin-1]

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : nginx] ***********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy html] *******************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Make sure mysql-server is installed] *****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Make sure python3-pymysql is installed] **************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : template] ********************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : Make sure mysql is started] **************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL database] **************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : MySQL user] ******************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Create user exporter] ********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL user for replication] **************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL replica read only mode ON] *********************************
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL replica read only mode OFF] ********************************
skipping: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [node_exporter : Install node exporters] **********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_backup : Create a directory for mysql backup] **********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_backup : Create user backup] ***************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_backup : copy my.cnf] **********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_backup : copy cron tab file] ***************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [rsyslog : copy pinger.service] *******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : Add backup user] ************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : Create /opt/agama] **********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [backup : Install duplicity] **********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : template backup server known_hosts] *****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_exporter : Check if prometheus-mysql-exporter is up to date] *******
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_exporter : pause] **************************************************
skipping: [LeonidVagulin-3]

TASK [mysql_exporter : copy my.cnf] ********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_exporter : copy args for slave metrics] ****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_exporter : conf prometheus-mysqld-exporter] ************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : Add pinger user] ************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : Install  fping] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : Create /etc/pinger] *********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : copy pinger.conf] ***********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : copy pinger.sh] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : copy pinger.service] ********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : daemon reload] **************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : pinger service start and conf] **********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

PLAY [Apps] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : Install docker] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : Log into DockerHub] *********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : Create /opt/agama] ***********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [agama : Download agama for Docker] ***************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : build agama for docker] ******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : install and run agama in docker] *********************************
[DEPRECATION WARNING]: The container_default_behavior option will change its 
default value from "compatibility" to "no_defaults" in community.docker 2.0.0. 
To remove this warning, please specify an explicit value for it now. This 
feature will be removed from community.docker in version 2.0.0. Deprecation 
warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : install and run agama in docker] *********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

PLAY [Keepalive and HA proxy] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : install keepalived] *****************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : copy script] ************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : Template keepalived.conf] ***********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : conf keepalived] ********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : install haproxy] ***********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : haproxy service start and conf] ********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : Template haproxy.cfg] ******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : haproxy exporter] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : copy conf for ha-exporter] ****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : conf prometheus-haproxy-exporter] *********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : copy exporter] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived_exporter : copy service] **************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : daemon reload] *************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : pinger service start and conf] *********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

PLAY [DNS records] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [dns_records : add CNAME] *************************************************
ok: [LeonidVagulin-1] => (item={'key': 'grafana', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'influxdb', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'lb1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'lb2', 'value': 'LeonidVagulin-2'})
ok: [LeonidVagulin-1] => (item={'key': 'mysql1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'mysql2', 'value': 'LeonidVagulin-2'})
ok: [LeonidVagulin-1] => (item={'key': 'ns1', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'prometheus', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'web1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'web2', 'value': 'LeonidVagulin-2'})

TASK [dns_records : add A records] *********************************************
ok: [LeonidVagulin-1] => (item={'key': 'backup-server', 'value': '192.168.42.156'})

PLAY RECAP *********************************************************************
LeonidVagulin-1            : ok=62   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
LeonidVagulin-2            : ok=83   changed=0    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
LeonidVagulin-3            : ok=83   changed=0    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   

+ ansible all -b -m reboot -a test_command=uptime
LeonidVagulin-1 | CHANGED => {
    "changed": true,
    "elapsed": 44,
    "rebooted": true
}
LeonidVagulin-3 | CHANGED => {
    "changed": true,
    "elapsed": 53,
    "rebooted": true
}
LeonidVagulin-2 | CHANGED => {
    "changed": true,
    "elapsed": 54,
    "rebooted": true
}
+ ansible-playbook infra.yaml --diff

PLAY [Init] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [init : Update APT cache] *************************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [init : Install iptables-persistent] **************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [init : Copy iptables.mangle] *********************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [init : Copy /etc/iptables/rules.v4] **************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [init : Fix for ssl] ******************************************************
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
[WARNING]: Attempts to restore iptables state without rollback in case of
mistake may lead the ansible controller to loose access to the hosts and never
regain it before fixing firewall rules through a serial console, or any other
way except SSH. Please set task attribute 'poll' (=15) to 0, and 'async' (=0)
to a value >2 and not greater than 'ansible_timeout' (=10) (recommended).
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]

TASK [node_exporter : Install node exporters] **********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [rsyslog : copy pinger.service] *******************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

PLAY [DNS server] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : install bind9] ****************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : bind9 service start and conf] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : Template named.conf.options] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : Copy db.deez] *****************************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Copy db.domain.reverse] *******************************************
skipping: [LeonidVagulin-2]
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-1]

TASK [bind : Copy local.conf] **************************************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [bind : shutdown systemd-resolved] ****************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind : Template resolv.conf] *********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind_exporter : Install prometheus-bind-exporter] ************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [bind_exporter : conf prometheus-bind-exporter] ***************************
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

PLAY [InfluxDB] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-1]

TASK [influxdb : apt_key] ******************************************************
ok: [LeonidVagulin-1]

TASK [influxdb : apt_repository] ***********************************************
ok: [LeonidVagulin-1]

TASK [influxdb : Install  influx and telegraf] *********************************
ok: [LeonidVagulin-1]

TASK [influxdb : influx service start and conf] ********************************
ok: [LeonidVagulin-1]

TASK [influxdb : config telegraf to recieve rsyslog and send to influx] ********
ok: [LeonidVagulin-1]

TASK [influxdb : config influxdb logging msg] **********************************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : install influxdb stats exporter] *********************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : Changing perm of influx db stats exporter] ***********
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : copy service for influx db stats exporter] ***********
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : daemon reload] ***************************************
ok: [LeonidVagulin-1]

TASK [influxdb_exporter : prometheus-influxdb-stats-exporterservice start and conf] ***
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Create a directory for influxdb backup] ****************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Install   python3-pip] *********************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : Install influxdb for pip] ******************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : create user backup] ************************************
ok: [LeonidVagulin-1]

TASK [influxdb_backup : crontab update influxdb_backup] ************************
ok: [LeonidVagulin-1]

TASK [nginx : nginx] ***********************************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy html] *******************************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-1]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-1]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-1]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
ok: [LeonidVagulin-1]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
ok: [LeonidVagulin-1]

TASK [prometheus : Install prometheus] *****************************************
ok: [LeonidVagulin-1]

TASK [prometheus : prometheus service start and conf] **************************
ok: [LeonidVagulin-1]

TASK [prometheus : Conf prometheus] ********************************************
ok: [LeonidVagulin-1]

TASK [prometheus : copy prometheus service conf] *******************************
ok: [LeonidVagulin-1]

TASK [docker : Install docker] *************************************************
ok: [LeonidVagulin-1]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-1]

TASK [docker : Log into DockerHub] *********************************************
ok: [LeonidVagulin-1]

TASK [grafana : Create folders for grafana] ************************************
ok: [LeonidVagulin-1] => (item=dashboards)
ok: [LeonidVagulin-1] => (item=datasources)

TASK [grafana : grafana-server template confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server datasources confs] ******************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server json confs] *************************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : grafana-server jsonfile confs] *********************************
ok: [LeonidVagulin-1]

TASK [grafana : install and run grafana in docker] *****************************
ok: [LeonidVagulin-1]

PLAY [Database server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : nginx] ***********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy html] *******************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [nginx : nginx service start and conf] ************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [nginx : copy default] ****************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [nginx_exporter : Install prometheus-nginx-exporter] **********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [nginx_exporter : conf prometheus-nginx-exporter] *************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Make sure mysql-server is installed] *****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Make sure python3-pymysql is installed] **************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : template] ********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Make sure mysql is started] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : MySQL database] **************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL user] ******************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : Create user exporter] ********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : MySQL user for replication] **************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql : MySQL replica read only mode ON] *********************************
skipping: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql : MySQL replica read only mode OFF] ********************************
skipping: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [node_exporter : Install node exporters] **********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [node_exporter : node-expoerter service start and conf] *******************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_backup : Create a directory for mysql backup] **********************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_backup : Create user backup] ***************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_backup : copy my.cnf] **********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_backup : copy cron tab file] ***************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [rsyslog : copy pinger.service] *******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : Add backup user] ************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [backup : Create /opt/agama] **********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [backup : Install duplicity] **********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [backup : template backup server known_hosts] *****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [mysql_exporter : Check if prometheus-mysql-exporter is up to date] *******
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_exporter : pause] **************************************************
skipping: [LeonidVagulin-3]

TASK [mysql_exporter : copy my.cnf] ********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_exporter : copy args for slave metrics] ****************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [mysql_exporter : conf prometheus-mysqld-exporter] ************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : Add pinger user] ************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : Install  fping] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : Create /etc/pinger] *********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : copy pinger.conf] ***********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : copy pinger.sh] *************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : copy pinger.service] ********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [pinger : daemon reload] **************************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [pinger : pinger service start and conf] **********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

PLAY [Apps] ********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : Install docker] *************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [docker : docker service start and conf] **********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [docker : Log into DockerHub] *********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [agama : Create /opt/agama] ***********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : Download agama for Docker] ***************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [agama : build agama for docker] ******************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [agama : install and run agama in docker] *********************************
[DEPRECATION WARNING]: The container_default_behavior option will change its 
default value from "compatibility" to "no_defaults" in community.docker 2.0.0. 
To remove this warning, please specify an explicit value for it now. This 
feature will be removed from community.docker in version 2.0.0. Deprecation 
warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [agama : install and run agama in docker] *********************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

PLAY [Keepalive and HA proxy] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : install keepalived] *****************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : copy script] ************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : Template keepalived.conf] ***********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived : conf keepalived] ********************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [haproxy : install haproxy] ***********************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : haproxy service start and conf] ********************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy : Template haproxy.cfg] ******************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : haproxy exporter] *************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : copy conf for ha-exporter] ****************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [haproxy_exporter : conf prometheus-haproxy-exporter] *********************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-3]

TASK [keepalived_exporter : copy exporter] *************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : copy service] **************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : daemon reload] *************************************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

TASK [keepalived_exporter : pinger service start and conf] *********************
ok: [LeonidVagulin-3]
ok: [LeonidVagulin-2]

PLAY [DNS records] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [LeonidVagulin-2]
ok: [LeonidVagulin-1]
ok: [LeonidVagulin-3]

TASK [dns_records : add CNAME] *************************************************
ok: [LeonidVagulin-1] => (item={'key': 'grafana', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'influxdb', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'lb1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'lb2', 'value': 'LeonidVagulin-2'})
ok: [LeonidVagulin-1] => (item={'key': 'mysql1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'mysql2', 'value': 'LeonidVagulin-2'})
ok: [LeonidVagulin-1] => (item={'key': 'ns1', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'prometheus', 'value': 'LeonidVagulin-1'})
ok: [LeonidVagulin-1] => (item={'key': 'web1', 'value': 'LeonidVagulin-3'})
ok: [LeonidVagulin-1] => (item={'key': 'web2', 'value': 'LeonidVagulin-2'})

TASK [dns_records : add A records] *********************************************
ok: [LeonidVagulin-1] => (item={'key': 'backup-server', 'value': '192.168.42.156'})

PLAY RECAP *********************************************************************
LeonidVagulin-1            : ok=62   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
LeonidVagulin-2            : ok=83   changed=0    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
LeonidVagulin-3            : ok=83   changed=0    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0   

+ date
Wed Dec 15 03:31:53 PM EET 2021
